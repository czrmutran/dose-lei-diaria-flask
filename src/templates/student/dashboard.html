{% extends "base.html" %}

{% block title %}Meu Painel - Dose de Lei Diária{% endblock %}

{% block head_extra %}
<style>
    /* ... (Estilos existentes - mantidos como no arquivo anterior) ... */

    /* --- NOVO: Estilos para o botão de Favorito --- */
    .favorite-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: #d1d5db; /* Cinza claro por padrão (não favorito) */
        font-size: 1.25rem; /* Tamanho do ícone */
        transition: color 0.2s ease, transform 0.2s ease;
        position: absolute; /* Posicionamento no card */
        top: 0.75rem;
        right: 0.75rem;
    }
    .favorite-btn:hover {
        transform: scale(1.1);
    }
    .favorite-btn.favorited {
        color: #facc15; /* Amarelo/Dourado para favorito */
    }
    .favorite-btn i {
        display: block; /* Garante que o ícone se comporte como bloco */
    }
    /* Ajuste para o card ter posição relativa para o botão absoluto */
    .law-card {
        /* ... (estilos existentes) ... */
        position: relative; /* Necessário para posicionar o botão de favorito */
    }
    /* --- FIM NOVO --- */

    /* --- NOVO: Estilo para o checkbox de favoritos --- */
    .favorite-filter-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.875rem;
        color: #374151;
    }
    .favorite-filter-label input[type="checkbox"] {
        margin-right: 0.5rem;
        cursor: pointer;
        accent-color: #2563eb; /* Cor do checkbox quando marcado */
    }
    /* --- FIM NOVO --- */

</style>
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-8" style="color: #2563eb;">Meu Painel</h1>

<!-- ... (Seções de Anúncios, Progresso, Pontos, Conquistas - mantidas como no arquivo anterior) ... -->

<!-- Filters and Search -->
<div class="mb-8 bg-gray-50 p-4 rounded-lg border border-gray-200">
    {# --- ATUALIZADO: Grid para 5 colunas para incluir checkbox de favoritos --- #}
    <form method="GET" action="{{ url_for('student.dashboard') }}" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
        <!-- Search Input -->
        <div>
            <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Buscar Legislação</label>
            <div class="flex items-center bg-white border border-gray-300 rounded-md shadow-sm">
                <span class="pl-3 pr-2 text-gray-400"><i class="fas fa-search"></i></span>
                <input type="text" id="search" name="search" placeholder="Título ou descrição..." 
                       class="flex-grow p-2 bg-transparent text-brand-text placeholder-gray-400 focus:outline-none focus:ring-0 border-0"
                       value="{{ search_query }}">
            </div>
        </div>
        <!-- Subject Filter -->
        <div>
            <label for="subject_id" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Matéria</label>
            <select id="subject_id" name="subject_id" class="shadow-sm appearance-none border border-gray-300 rounded-md w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:border-transparent bg-white"
                    style="focus:ring: 2px solid #60a5fa;">
                <option value="">-- Todas as Matérias --</option>
                {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if selected_subject_id == subject.id|string %}selected{% endif %}>{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Status Filter -->
        <div>
            <label for="status_filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Status</label>
            <select id="status_filter" name="status_filter" class="shadow-sm appearance-none border border-gray-300 rounded-md w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:border-transparent bg-white"
                    style="focus:ring: 2px solid #60a5fa;">
                <option value="">-- Todos os Status --</option>
                <option value="not_read" {% if selected_status == 'not_read' %}selected{% endif %}>Não Lidas</option>
                <option value="in_progress" {% if selected_status == 'in_progress' %}selected{% endif %}>Em Andamento</option>
                <option value="completed" {% if selected_status == 'completed' %}selected{% endif %}>Concluídas</option>
            </select>
        </div>
        <!-- --- NOVO: Favorite Filter Checkbox --- -->
        <div class="flex items-end pb-1"> {# Ajuste de alinhamento #}
            <label for="show_favorites" class="favorite-filter-label">
                <input type="checkbox" id="show_favorites" name="show_favorites" 
                       {% if show_favorites %}checked{% endif %}>
                Mostrar apenas favoritas
            </label>
        </div>
        <!-- --- FIM NOVO --- -->
        <!-- Action Buttons -->
        <div class="flex items-center space-x-2">
            <button type="submit" class="w-full md:w-auto text-white p-2 px-4 rounded-md focus:outline-none transition duration-300"
                    style="background-color: #2563eb; border: none;"
                    onmouseover="this.style.backgroundColor='#1d4ed8'"
                    onmouseout="this.style.backgroundColor='#2563eb'">
                Aplicar Filtros
            </button>
            {# --- ATUALIZADO: Condição do botão Limpar para incluir show_favorites --- #}
            {% if search_query or selected_subject_id or selected_status or show_favorites %}
                <a href="{{ url_for('student.dashboard') }}" class="w-full md:w-auto text-center p-2 px-4 border border-gray-300 rounded-md text-sm text-brand-text-light bg-white hover:bg-gray-50">Limpar</a>
            {% endif %}
        </div>
    </form>
</div>

<!-- List of Laws -->
<h2 class="text-2xl font-semibold mb-6" style="color: #2563eb;">Legislações Disponíveis</h2>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% if laws %}
        {% for law in laws %}
        {# --- ATUALIZADO: Adicionado data-law-id ao card --- #}
        <div class="law-card p-5" data-law-id="{{ law.id }}">
            {# --- NOVO: Botão de Favorito --- #}
            <button class="favorite-btn {% if law.id in favorite_law_ids %}favorited{% endif %}" 
                    title="{% if law.id in favorite_law_ids %}Remover dos Favoritos{% else %}Adicionar aos Favoritos{% endif %}">
                {# Ícone muda baseado na classe 'favorited' #}
                <i class="{% if law.id in favorite_law_ids %}fas fa-star{% else %}far fa-star{% endif %}"></i> 
            </button>
            {# --- FIM NOVO --- #}
            <div class="card-content">
                {# Ajustado padding-right para não sobrepor o botão de favorito #}
                <div class="flex justify-between items-start mb-2 pr-8"> 
                    <h3 class="text-lg font-semibold text-brand-text mr-2">{{ law.title }}</h3>
                    {# Status badges (Concluído/Em andamento) - mantidos como antes #}
                    {% if law.id in completed_law_ids %}
                        <span class="completed-badge">
                            <i class="fas fa-check mr-1"></i> Concluído
                        </span>
                    {% elif law.id in in_progress_law_ids %}
                        <span class="in-progress-badge">
                            <i class="fas fa-pencil-alt mr-1"></i> Em andamento
                        </span>
                    {% endif %}
                </div>
                {% if law.subject %}
                <p class="text-xs font-medium mb-2" style="color: #2563eb;">{{ law.subject.name }}</p>
                {% endif %}
                <p class="text-sm text-brand-text-light mb-3">{{ law.description or "Acesse para ver o conteúdo." }}</p>
                <div class="text-xs text-gray-400 mt-2 mb-4">
                    <!-- Artigos: X | Lidos: Y -->
                </div>
            </div>
            <div class="card-actions flex justify-between items-center mt-auto">
                 <a href="{{ url_for('student.view_law', law_id=law.id) }}" class="action-button w-full">
                     <i class="fas fa-book-open mr-2"></i> Ler Legislação
                 </a>
                 {% if law.id in completed_law_ids %}
                    {# --- ATUALIZADO: Passar show_favorites para a rota de review --- #}
                    <form action="{{ url_for('student.review_law', law_id=law.id, search=search_query, subject_id=selected_subject_id, status_filter=selected_status, show_favorites='on' if show_favorites else None) }}" method="POST" class="inline-block ml-2">
                        <button type="submit" class="review-button" title="Marcar como não concluído para rever">
                            <i class="fas fa-undo-alt"></i>
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="text-brand-text-light italic md:col-span-2 lg:col-span-3 text-center py-8">
            {# --- ATUALIZADO: Condição de 'nenhuma legislação' para incluir show_favorites --- #}
            {% if search_query or selected_subject_id or selected_status or show_favorites %}
                Nenhuma legislação encontrada com os filtros aplicados.
            {% else %}
                Nenhuma legislação disponível no momento.
            {% endif %}
        </p>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
{# --- NOVO: Script para lidar com o clique no botão de favorito --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const favoriteButtons = document.querySelectorAll('.favorite-btn');

    favoriteButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // Previne qualquer ação padrão do botão
            const lawCard = this.closest('.law-card');
            const lawId = lawCard.getAttribute('data-law-id');
            const icon = this.querySelector('i');
            const isFavorited = this.classList.contains('favorited');
            const url = `/student/law/toggle_favorite/${lawId}`;

            // Otimistic UI update (muda o ícone imediatamente)
            this.classList.toggle('favorited');
            if (this.classList.contains('favorited')) {
                icon.classList.remove('far'); // Remove ícone vazio
                icon.classList.add('fas');    // Adiciona ícone preenchido
                this.setAttribute('title', 'Remover dos Favoritos');
            } else {
                icon.classList.remove('fas'); // Remove ícone preenchido
                icon.classList.add('far');    // Adiciona ícone vazio
                this.setAttribute('title', 'Adicionar aos Favoritos');
            }

            // Envia a requisição para o backend
            fetch(url, {
                method: 'POST',
                headers: {
                    // Se você usa CSRF protection, adicione o token aqui
                    // 'X-CSRFToken': '{{ csrf_token() }}' // Exemplo se usar Flask-WTF
                    'Content-Type': 'application/json' // Embora não enviemos corpo, é boa prática
                },
                // body: JSON.stringify({}) // Não precisamos enviar corpo para esta ação
            })
            .then(response => {
                if (!response.ok) {
                    // Se a resposta não for OK, reverte a UI e loga o erro
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    // Se o backend reportar erro, reverte a UI
                    console.error('Erro ao favoritar:', data.error);
                    // Reverte a mudança visual
                    this.classList.toggle('favorited'); 
                    if (this.classList.contains('favorited')) {
                        icon.classList.remove('far'); icon.classList.add('fas');
                        this.setAttribute('title', 'Remover dos Favoritos');
                    } else {
                        icon.classList.remove('fas'); icon.classList.add('far');
                        this.setAttribute('title', 'Adicionar aos Favoritos');
                    }
                    alert('Ocorreu um erro ao atualizar os favoritos. Tente novamente.');
                } else {
                    // Sucesso! A UI já foi atualizada otimisticamente.
                    console.log(`Law ${lawId} favorite status updated to: ${data.favorited}`);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                // Reverte a mudança visual em caso de erro de rede/fetch
                this.classList.toggle('favorited');
                if (this.classList.contains('favorited')) {
                    icon.classList.remove('far'); icon.classList.add('fas');
                    this.setAttribute('title', 'Remover dos Favoritos');
                } else {
                    icon.classList.remove('fas'); icon.classList.add('far');
                    this.setAttribute('title', 'Adicionar aos Favoritos');
                }
                alert('Ocorreu um erro de comunicação ao atualizar os favoritos. Verifique sua conexão e tente novamente.');
            });
        });
    });
});
</script>
{# --- FIM NOVO --- #}
{% endblock %}

