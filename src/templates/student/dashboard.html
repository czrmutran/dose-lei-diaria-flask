{% extends "base.html" %}

{% block title %}Meu Painel - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    /* ... (Todos os seus estilos CSS permanecem exatamente os mesmos) ... */
    .law-card { transition: all 0.3s ease; background-color: #FFFFFF; border: 1px solid #dbeafe; color: #374151; display: flex; flex-direction: column; justify-content: space-between; min-height: 170px; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); position: relative; }
    .law-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1), 0 4px 6px -2px rgba(37, 99, 235, 0.05); border-color: #93c5fd; }
    .progress-bar-container { height: 10px; border-radius: 5px; background-color: #dbeafe; overflow: hidden; }
    .progress-bar-fill { height: 100%; border-radius: 5px; background-color: #2563eb; transition: width 0.5s ease; }
    .completed-badge { background-color: #D1FAE5; color: #065F46; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; }
    .in-progress-badge { background-color: #DBEAFE; color: #1E40AF; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; }
    .action-button { background-color: #2563eb; color: white; font-size: 0.875rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; border: none; cursor: pointer; transition: background-color 0.2s ease; text-align: center; display: inline-flex; align-items: center; justify-content: center; }
    .action-button:hover { background-color: #1d4ed8; }
    .achievement-badge { display: inline-flex; align-items: center; background-color: #FEF3C7; color: #92400E; font-size: 0.8rem; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 500; border: 1px solid #FDE68A; }
    .achievement-badge i { margin-right: 0.4rem; color: #D97706; }
    .favorite-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; color: #d1d5db; font-size: 1.25rem; transition: color 0.2s ease, transform 0.2s ease; }
    .favorite-btn:hover { transform: scale(1.1); }
    .favorite-btn.favorited { color: #facc15; }
    .favorite-btn i { display: block; }
    .rich-content img { max-width: 100%; height: auto; border-radius: 0.375rem; margin: 0.5rem 0; }
    .rich-content a { color: #2563eb; text-decoration: underline; }
    .rich-content a:hover { color: #1d4ed8; }
    .rich-content ul, .rich-content ol { margin-left: 1.5rem; margin-bottom: 0.5rem; }
    .rich-content blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; margin: 0.5rem 0; color: #4b5563; }
    .announcement-container { margin-bottom: 2rem; transition: all 0.3s ease; }
    .fixed-announcement-box { background-color: #ECFDF5; border: 1px solid #A7F3D0; border-left: 4px solid #10B981; color: #064E3B; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -1px rgba(16, 185, 129, 0.06); position: relative; overflow: hidden; }
    .fixed-announcement-box h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; color: #065F46; }
    .fixed-announcement-box h2 i { margin-right: 0.75rem; color: #10B981; font-size: 1.25rem; }
    .fixed-announcement-item { padding: 0.75rem 0; border-top: 1px dashed rgba(167, 243, 208, 0.7); transition: all 0.3s ease; }
    .fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .fixed-announcement-item:last-child { padding-bottom: 0; }
    .announcement-box { background-color: #FEF9C3; border: 1px solid #FDE68A; border-left: 4px solid #F59E0B; color: #92400E; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1), 0 2px 4px -1px rgba(245, 158, 11, 0.06); position: relative; overflow: hidden; transition: all 0.3s ease; }
    .announcement-box h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; color: #92400E; }
    .announcement-box h2 i { margin-right: 0.75rem; color: #F59E0B; font-size: 1.25rem; }
    .non-fixed-announcement-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-top: 1px dashed rgba(252, 211, 77, 0.7); transition: all 0.3s ease; }
    .non-fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .non-fixed-announcement-item:last-child { padding-bottom: 0; }
    .non-fixed-announcement-item .announcement-content { flex-grow: 1; }
    .mark-seen-checkbox-container { position: relative; min-width: 1.5rem; height: 1.5rem; margin-top: 0.2rem; }
    .mark-seen-checkbox { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    .checkmark { position: absolute; top: 0; left: 0; height: 1.5rem; width: 1.5rem; background-color: #FEF9C3; border: 2px solid #F59E0B; border-radius: 4px; transition: all 0.2s ease; }
    .mark-seen-checkbox:hover ~ .checkmark { background-color: #FDE68A; }
    .mark-seen-checkbox:checked ~ .checkmark { background-color: #F59E0B; border-color: #D97706; }
    .checkmark:after { content: ""; position: absolute; display: none; }
    .mark-seen-checkbox:checked ~ .checkmark:after { display: block; }
    .mark-seen-checkbox-container .checkmark:after { left: 0.45rem; top: 0.2rem; width: 0.35rem; height: 0.7rem; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .mark-seen-checkbox-container .tooltip { visibility: hidden; width: 120px; background-color: rgba(0, 0, 0, 0.8); color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; }
    .mark-seen-checkbox-container:hover .tooltip { visibility: visible; opacity: 1; }
    @keyframes fadeOut { from { opacity: 1; height: auto; } to { opacity: 0; height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; border-width: 0; } }
    .fade-out { animation: fadeOut 0.5s ease forwards; overflow: hidden; }
    .continue-block { background-color: #EFF6FF; border: 1px solid #BFDBFE; border-left: 4px solid #3B82F6; color: #1E40AF; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06); transition: all 0.3s ease; }
    .continue-block:hover { box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1), 0 4px 6px -2px rgba(59, 130, 246, 0.05); transform: translateY(-2px); }
    .continue-block h3 { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: flex; align-items: center; color: #1E40AF; }
    .continue-block h3 i { margin-right: 0.5rem; color: #3B82F6; }
    .continue-block a { font-size: 1.125rem; font-weight: 600; color: #1E3A8A; text-decoration: none; transition: all 0.2s ease; display: block; }
    .continue-block a:hover { color: #3B82F6; text-decoration: underline; }
    .stat-card { background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -2px rgba(0, 0, 0, 0.05); transition: all 0.3s ease-in-out; display: flex; flex-direction: column; height: 100%; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.06); border-color: #60a5fa; }
    .stat-card-title { display: flex; align-items: center; font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
    .stat-card-title i { margin-right: 0.75rem; font-size: 1.25rem; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }
    .progress-card .stat-card-title i { color: #3b82f6; background-color: #eff6ff; }
    .points-card { text-align: center; justify-content: center; background: linear-gradient(145deg, #fffbeb, #fefce8); border-color: #fde68a; }
    .points-card .stat-card-title { justify-content: center; }
    .points-card .stat-card-title i { color: #f59e0b; background-color: #ffffff; }
    .points-display { font-size: 2.75rem; font-weight: 800; color: #d97706; line-height: 1; margin-top: 0.5rem; }
    .achievements-card .stat-card-title i { color: #8b5cf6; background-color: #f5f3ff; }
    .achievements-list { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 0.5rem; }
    .achievements-card .achievement-badge { border: 1px solid transparent; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .filter-container { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
    .filter-label { display: block; font-size: 0.875rem; font-weight: 500; color: #334155; margin-bottom: 0.5rem; }
    .filter-label i { color: #64748b; margin-right: 0.5rem; width: 16px; text-align: center; display: inline-block; }
    .custom-input { width: 100%; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem; font-size: 0.875rem; color: #1e2937; transition: border-color 0.2s ease, box-shadow 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .custom-input::placeholder { color: #94a3b8; }
    .custom-input:focus { outline: none; border-color: #2563eb; background-color: #ffffff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    select.custom-input { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
    .accordion-item { border-radius: 0.5rem; overflow: hidden; margin-bottom: 0.75rem; background-color: #fff; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03); }
    .accordion-header { padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
    .accordion-header:hover { background-color: #f8fafc; }
    .accordion-header .diploma-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; display: flex; align-items: center; }
    .accordion-header .diploma-title .icon { margin-right: 0.75rem; color: #3b82f6; }
    .accordion-header .diploma-progress { display: flex; align-items: center; gap: 0.75rem; width: 30%; }
    .accordion-content { display: none; padding: 0.5rem 1.5rem 1.5rem 1.5rem; border-top: 1px solid #e2e8f0; background-color: #fdfdff; }
    .topic-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px dashed #e2e8f0; }
    .topic-item:last-child { border-bottom: none; }
    .topic-title { display: flex; align-items: center; color: #334155; }
    .topic-title .icon { margin-right: 0.75rem; color: #94a3b8; }
    .topic-actions { display: flex; align-items: center; gap: 0.75rem; }
    .accordion-toggle-icon { transition: transform 0.3s ease; transform: rotate(0deg); }
    .accordion-header.open .accordion-toggle-icon { transform: rotate(90deg); }
    .review-button { background-color: #6b7280; color: white; border: none; border-radius: 9999px; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s ease; }
    .review-button:hover { background-color: #4b5563; }
    @media (max-width: 768px) {
        .fixed-announcement-box, .announcement-box { padding: 1rem; }
        .non-fixed-announcement-item { gap: 0.75rem; }
        .fixed-announcement-box h2, .announcement-box h2 { font-size: 1.1rem; }
        .accordion-header .diploma-progress { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-8" style="color: #2563eb;">Meu Painel</h1>

{% if last_accessed_law %}
<div class="continue-block">
    <h3><i class="fas fa-history"></i> Continuar de onde parou:</h3>
    <a href="{{ url_for('student.view_law', law_id=last_accessed_law.id) }}">{{ last_accessed_law.parent.title + ' - ' if last_accessed_law.parent else '' }}{{ last_accessed_law.title }}</a>
</div>
{% endif %}

{% if fixed_announcements %}
<div class="announcement-container">
    <div class="fixed-announcement-box">
        {% for announcement in fixed_announcements %}
        <div class="fixed-announcement-item {% if not loop.first %}mt-3{% endif %}">
            <h2><i class="fas fa-thumbtack"></i>{{ announcement.title }}</h2>
            <div class="announcement-content rich-content">{{ announcement.content|safe }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% if non_fixed_announcements %}
<div class="announcement-container" id="non-fixed-announcements-container">
    <div class="announcement-box">
        <h2><i class="fas fa-bullhorn"></i> Avisos Recentes</h2>
        {% for announcement in non_fixed_announcements %}
        <div class="non-fixed-announcement-item" data-announcement-id="{{ announcement.id }}">
            <div class="mark-seen-checkbox-container">
                <input type="checkbox" class="mark-seen-checkbox">
                <span class="checkmark"></span>
                <span class="tooltip">Marcar como visto</span>
            </div>
            <div class="announcement-content">
                <h3 class="text-md font-semibold">{{ announcement.title }}</h3>
                <div class="text-sm rich-content">{{ announcement.content|safe }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="md:col-span-2 stat-card progress-card">
        <h2 class="stat-card-title"><i class="fas fa-chart-line"></i> Meu progresso</h2>
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-600">Tópicos Concluídos: {{ completed_count }} / {{ total_laws }}</span>
            <span class="text-sm font-bold" style="color: #2563eb;">{{ "%.0f"|format(progress_percentage) }}%</span>
        </div>
        <div class="progress-bar-container w-full">
            <div class="progress-bar-fill" style="width: {{ progress_percentage }}%;"></div>
        </div>
    </div>
    <div class="stat-card points-card">
        <h2 class="stat-card-title"><i class="fas fa-star"></i> Meus Pontos</h2>
        <div class="points-display">{{ user_points }}</div>
    </div>
</div>

<div class="stat-card achievements-card mb-8">
    <h2 class="stat-card-title"><i class="fas fa-trophy"></i> Minhas Conquistas</h2>
    {% if user_achievements %}
        <div class="achievements-list">
            {% for achievement in user_achievements %}
                <span class="achievement-badge" title="{{ achievement.description }}">
                    <i class="{{ achievement.icon or 'fas fa-trophy' }}"></i> {{ achievement.name }}
                </span>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 italic mt-2">Você ainda não desbloqueou nenhuma conquista. Continue estudando!</p>
    {% endif %}
</div>


<div class="filter-container mb-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-6">
        <div>
             <label for="search" class="filter-label"><i class="fas fa-search"></i>Buscar Legislação (Ignora filtros)</label>
             <input type="text" id="search" name="search" placeholder="Buscar por matéria ou título..." class="custom-input">
        </div>
        <div class="flex items-end pb-2">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="show_favorites" name="show_favorites" class="h-4 w-4 rounded border-gray-300">
                <span class="ml-2 text-sm text-gray-700">Apenas favoritas</span>
            </label>
        </div>
    </div>

    <hr class="my-6 border-t border-gray-200">

    <div id="filter-controls" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
        <div>
            <label for="subject_id" class="filter-label"><i class="fas fa-book-open"></i>1. Filtrar por Matéria</label>
            <select id="subject_id" name="subject_id" class="custom-input">
                <option value="">-- Todas as Matérias --</option>
                {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="diploma_id" class="filter-label"><i class="fas fa-gavel"></i>2. Filtrar por Lei</label>
            <select id="diploma_id" name="diploma_id" class="custom-input" disabled>
                <option value="">-- Selecione uma Matéria --</option>
            </select>
        </div>
        
        <div id="refinement-wrapper" class="lg:col-span-1" style="visibility: hidden;">
            <label class="filter-label"><i class="fas fa-filter"></i>3. Refinar por</label>
            <div class="flex items-center space-x-4 mb-2">
                <label class="flex items-center text-sm cursor-pointer">
                    <input type="radio" name="refine_type" value="status" class="h-4 w-4" checked>
                    <span class="ml-1.5">Status</span>
                </label>
                <label class="flex items-center text-sm cursor-pointer">
                    <input type="radio" name="refine_type" value="section" class="h-4 w-4">
                    <span class="ml-1.5">Trecho</span>
                </label>
            </div>
            
            <div id="status-filter-wrapper">
                <select id="status_filter" name="status_filter" class="custom-input">
                    <option value="">-- Todos os Status --</option>
                    <option value="not_read">Não Lidas</option>
                    <option value="in_progress">Em Andamento</option>
                    <option value="completed">Concluídas</option>
                </select>
            </div>
            <div id="section-filter-wrapper" style="display: none;">
                 <input type="text" id="section_filter" name="section_filter" placeholder="Buscar no texto da lei..." class="custom-input">
            </div>
        </div>

        <div>
            <label class="filter-label">&nbsp;</label>
            <button type="button" id="clear-filters-btn" class="w-full flex items-center justify-center px-4 py-2.5 border border-gray-300 rounded-md text-sm text-gray-600 bg-white hover:bg-gray-50">Limpar Filtros</button>
        </div>
    </div>
</div>
<h2 class="text-2xl font-semibold mb-6" style="color: #2563eb;">Legislações Disponíveis</h2>
<div id="laws-accordion-container">
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DO DOM ---
    const filterControls = {
        search: document.getElementById('search'),
        subject: document.getElementById('subject_id'),
        diploma: document.getElementById('diploma_id'),
        favorites: document.getElementById('show_favorites'),
        clearButton: document.getElementById('clear-filters-btn'),
        
        // Novos elementos para o refinamento
        refinementWrapper: document.getElementById('refinement-wrapper'),
        refineTypeRadios: document.querySelectorAll('input[name="refine_type"]'),
        statusFilterWrapper: document.getElementById('status-filter-wrapper'),
        sectionFilterWrapper: document.getElementById('section-filter-wrapper'),
        statusFilter: document.getElementById('status_filter'),
        sectionFilter: document.getElementById('section_filter'),
    };
    const accordionContainer = document.getElementById('laws-accordion-container');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    let debounceTimer;

    // --- FUNÇÕES DE LÓGICA DE FILTRAGEM ---

    async function fetchAndRenderLaws() {
        const search = filterControls.search.value;
        const subjectId = filterControls.subject.value;
        const diplomaId = filterControls.diploma.value;
        const showFavorites = filterControls.favorites.checked;
        const refineType = document.querySelector('input[name="refine_type"]:checked').value;
        
        accordionContainer.innerHTML = '<p class="text-center py-8 text-gray-500">Carregando...</p>';

        const params = new URLSearchParams();
        if (showFavorites) params.append('show_favorites', showFavorites);

        if (search) {
            params.append('search', search);
        } else {
            if (subjectId) params.append('subject_id', subjectId);
            if (diplomaId) {
                params.append('diploma_id', diplomaId);
                // Adiciona o filtro de refinamento apenas se uma lei estiver selecionada
                if (refineType === 'status') {
                    if (filterControls.statusFilter.value) {
                         params.append('status_filter', filterControls.statusFilter.value);
                    }
                } else { // refineType === 'section'
                    if (filterControls.sectionFilter.value) {
                        params.append('section_query', filterControls.sectionFilter.value);
                    }
                }
            }
        }
        
        try {
            const response = await fetch(`/student/filter_laws?${params.toString()}`);
            if (!response.ok) throw new Error('Falha na resposta do servidor.');
            
            const data = await response.json();
            renderLaws(data.subjects_with_diplomas, !!search); // Passa um flag se a busca está ativa
        } catch (error) {
            console.error('Erro ao buscar leis:', error);
            accordionContainer.innerHTML = '<p class="text-center py-8 text-red-500">Ocorreu um erro ao carregar as legislações. Tente novamente.</p>';
        }
    }
    
    async function updateDiplomaFilter(subjectId) {
        filterControls.diploma.innerHTML = '<option value="">-- Selecione uma Matéria --</option>';
        filterControls.diploma.disabled = true;
        
        // Oculta e reseta o bloco de refinamento
        filterControls.refinementWrapper.style.visibility = 'hidden';
        filterControls.statusFilter.value = '';
        filterControls.sectionFilter.value = '';

        if (!subjectId) {
            fetchAndRenderLaws();
            return;
        }

        filterControls.diploma.innerHTML = '<option value="">Carregando leis...</option>';
        try {
            const response = await fetch(`/student/api/laws_for_subject/${subjectId}`);
            const laws = await response.json();

            filterControls.diploma.innerHTML = '<option value="">-- Todas as Leis da Matéria --</option>';
            laws.forEach(law => {
                const option = new Option(law.title, law.id);
                filterControls.diploma.appendChild(option);
            });
            filterControls.diploma.disabled = false;
        } catch (error) {
            console.error("Erro ao buscar leis:", error);
            filterControls.diploma.innerHTML = '<option value="">Erro ao carregar</option>';
        }

        fetchAndRenderLaws();
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO (Inalteradas) ---
    // ... (As funções renderLaws e renderTopicItem permanecem exatamente as mesmas) ...
    function renderLaws(subjects, isSearchActive) {
        if (Object.keys(subjects).length === 0) {
            accordionContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-500 italic">Nenhuma legislação encontrada com os filtros selecionados.</p></div>';
            return;
        }

        let html = '';
        for (const subjectName in subjects) {
            html += `<div class="mb-6"><h3 class="text-lg font-bold text-gray-700 mb-3">${subjectName}</h3>`;
            subjects[subjectName].forEach(diploma => {
                const isOpen = isSearchActive || filterControls.diploma.value;
                const openClass = isOpen ? 'open' : '';
                const displayStyle = isOpen ? 'block' : 'none';
                const iconRotation = isOpen ? 'rotate(90deg)' : 'rotate(0deg)';

                html += `
                <div class="accordion-item">
                    <div class="accordion-header ${openClass}">
                        <div class="diploma-title"><i class="fas fa-gavel icon"></i><span>${diploma.title}</span></div>
                        <div class="diploma-progress">
                            <div class="progress-bar-container w-full"><div class="progress-bar-fill" style="width: ${diploma.progress_percentage || 0}%;"></div></div>
                            <span class="text-sm font-bold" style="color: #2563eb;">${Math.round(diploma.progress_percentage || 0)}%</span>
                            <i class="fas fa-chevron-right accordion-toggle-icon" style="transform: ${iconRotation};"></i>
                        </div>
                    </div>
                    <div class="accordion-content" style="display: ${displayStyle};">
                        ${diploma.filtered_children.length > 0 ? diploma.filtered_children.map(topic => renderTopicItem(topic)).join('') : '<p class="text-gray-500 italic text-center py-4">Nenhum tópico de estudo encontrado.</p>'}
                    </div>
                </div>`;
            });
            html += `</div>`;
        }
        accordionContainer.innerHTML = html;
        attachEventListeners();
    }

    function renderTopicItem(topic) {
        let statusBadge = '';
        if (topic.is_completed) statusBadge = '<span class="completed-badge">Concluída</span>';
        else if (topic.is_in_progress) statusBadge = '<span class="in-progress-badge">Em Andamento</span>';

        let actionButtonText = '';
        if (topic.is_completed) actionButtonText = '<i class="fas fa-check-circle mr-1"></i> Revisar';
        else if (topic.is_in_progress) actionButtonText = '<i class="fas fa-book-reader mr-1"></i> Continuar';
        else actionButtonText = '<i class="fas fa-book mr-1"></i> Começar';

        const reviewButton = topic.is_completed ? `
            <button type="button" class="review-button js-mark-incomplete-btn" data-law-id="${topic.id}" title="Marcar como não concluído">
                <i class="fas fa-undo-alt"></i>
            </button>` : '';
        
        const favoriteClass = topic.is_favorite ? 'favorited' : '';
        const favoriteIcon = topic.is_favorite ? 'fas fa-star' : 'far fa-star';
        const favoriteTitle = topic.is_favorite ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos';

        return `
        <div class="topic-item" data-law-id="${topic.id}">
            <div class="topic-title"><i class="fas fa-file-alt icon"></i><span>${topic.title}</span></div>
            <div class="topic-actions">
                ${statusBadge}
                <a href="/student/law/${topic.id}" class="action-button">${actionButtonText}</a>
                ${reviewButton}
                <button type="button" class="favorite-btn js-favorite-btn ${favoriteClass}" data-law-id="${topic.id}" title="${favoriteTitle}">
                    <i class="${favoriteIcon}"></i>
                </button>
            </div>
        </div>`;
    }

    // --- EVENT LISTENERS ---

    function attachEventListeners() {
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const icon = this.querySelector('.accordion-toggle-icon');
                this.classList.toggle('open');
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(90deg)';
                }
            });
        });

        document.querySelectorAll('.js-favorite-btn').forEach(button => button.addEventListener('click', handleFavoriteClick));
        document.querySelectorAll('.js-mark-incomplete-btn').forEach(button => button.addEventListener('click', handleMarkIncompleteClick));
    }
    
    // Listener da busca principal
    filterControls.search.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        // Limpa e desativa os outros filtros
        filterControls.subject.value = '';
        filterControls.diploma.innerHTML = '<option value="">-- Selecione uma Matéria --</option>';
        filterControls.diploma.disabled = true;
        filterControls.refinementWrapper.style.visibility = 'hidden';
        filterControls.statusFilter.value = '';
        filterControls.sectionFilter.value = '';

        debounceTimer = setTimeout(fetchAndRenderLaws, 300);
    });

    // Listener da Matéria
    filterControls.subject.addEventListener('change', () => {
        filterControls.search.value = '';
        updateDiplomaFilter(filterControls.subject.value);
    });

    // Listener da Lei
    filterControls.diploma.addEventListener('change', () => {
        filterControls.search.value = '';
        const diplomaId = filterControls.diploma.value;
        // Mostra ou oculta o bloco de refinamento
        filterControls.refinementWrapper.style.visibility = diplomaId ? 'visible' : 'hidden';
        fetchAndRenderLaws();
    });

    // Listener para os botões de rádio (Status/Trecho)
    filterControls.refineTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            const isStatus = radio.value === 'status';
            filterControls.statusFilterWrapper.style.display = isStatus ? 'block' : 'none';
            filterControls.sectionFilterWrapper.style.display = isStatus ? 'none' : 'block';
            
            // Limpa o valor do filtro que foi ocultado e busca novamente
            if (isStatus) {
                filterControls.sectionFilter.value = '';
            } else {
                filterControls.statusFilter.value = '';
            }
            fetchAndRenderLaws();
        });
    });
    
    // Listener para o filtro de Status
    filterControls.statusFilter.addEventListener('change', () => {
        filterControls.search.value = '';
        fetchAndRenderLaws();
    });
    
    // Listener para o filtro de Trecho (com debounce)
    filterControls.sectionFilter.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        filterControls.search.value = '';
        debounceTimer = setTimeout(fetchAndRenderLaws, 300);
    });

    // Listener para Apenas Favoritas
    filterControls.favorites.addEventListener('change', fetchAndRenderLaws);

    // Listener para Limpar Filtros
    filterControls.clearButton.addEventListener('click', () => {
        filterControls.search.value = '';
        filterControls.subject.value = '';
        filterControls.diploma.innerHTML = '<option value="">-- Selecione uma Matéria --</option>';
        filterControls.diploma.disabled = true;
        filterControls.favorites.checked = false;
        
        // Reseta e oculta o bloco de refinamento
        filterControls.refinementWrapper.style.visibility = 'hidden';
        document.querySelector('input[name="refine_type"][value="status"]').checked = true;
        filterControls.statusFilterWrapper.style.display = 'block';
        filterControls.sectionFilterWrapper.style.display = 'none';
        filterControls.statusFilter.value = '';
        filterControls.sectionFilter.value = '';

        fetchAndRenderLaws();
    });

    // --- OUTRAS FUNCIONALIDADES (INALTERADAS) ---

    const markSeenCheckboxes = document.querySelectorAll('.mark-seen-checkbox');
    markSeenCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            this.disabled = true;
            const announcementItem = this.closest('.non-fixed-announcement-item');
            const announcementId = announcementItem.getAttribute('data-announcement-id');
            const apiUrl = `/student/announcement/${announcementId}/mark_seen`;
            
            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    announcementItem.classList.add('fade-out');
                    setTimeout(() => {
                        announcementItem.remove();
                        if (document.querySelectorAll('.non-fixed-announcement-item').length === 0) {
                            document.getElementById('non-fixed-announcements-container')?.remove();
                        }
                    }, 500);
                } else { this.checked = false; this.disabled = false; }
            })
            .catch(error => { console.error('Erro:', error); this.checked = false; this.disabled = false; });
        });
    });

    function handleFavoriteClick() {
        const button = this;
        button.disabled = true;
        const lawId = button.dataset.lawId;
        const icon = button.querySelector('i');
        
        fetch(`/student/law/toggle_favorite/${lawId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.favorited) {
                button.classList.add('favorited');
                icon.className = 'fas fa-star';
                button.title = 'Remover dos Favoritos';
            } else {
                button.classList.remove('favorited');
                icon.className = 'far fa-star';
                button.title = 'Adicionar aos Favoritos';
                if (filterControls.favorites.checked) {
                    button.closest('.topic-item').remove();
                }
            }
        })
        .catch(error => console.error('Erro:', error))
        .finally(() => { button.disabled = false; });
    }

    function handleMarkIncompleteClick() {
        const buttonEl = this;
        buttonEl.disabled = true;
        const lawId = buttonEl.dataset.lawId;
        
        fetch(`/student/law/review/${lawId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.new_status === 'em_andamento') {
                fetchAndRenderLaws();
            } else {
                alert('Erro ao atualizar o status: ' + (data.error || 'Desconhecido'));
                buttonEl.disabled = false;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Ocorreu um erro de comunicação.');
            buttonEl.disabled = false;
        });
    }

    // --- CARGA INICIAL ---
    fetchAndRenderLaws();
});
</script>
{% endblock %}
