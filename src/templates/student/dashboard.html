{% extends "base.html" %}

{% block title %}Meu Painel - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    /* Estilos Base e de Componentes do seu arquivo original */
    .law-card { transition: all 0.3s ease; background-color: #FFFFFF; border: 1px solid #dbeafe; color: #374151; display: flex; flex-direction: column; justify-content: space-between; min-height: 170px; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); position: relative; }
    .law-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1), 0 4px 6px -2px rgba(37, 99, 235, 0.05); border-color: #93c5fd; }
    .progress-bar-container { height: 10px; border-radius: 5px; background-color: #dbeafe; overflow: hidden; }
    .progress-bar-fill { height: 100%; border-radius: 5px; background-color: #2563eb; transition: width 0.5s ease; }
    .completed-badge { background-color: #D1FAE5; color: #065F46; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; margin-left: auto; flex-shrink: 0; }
    .in-progress-badge { background-color: #DBEAFE; color: #1E40AF; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; margin-left: auto; flex-shrink: 0; }
    .action-button { background-color: #2563eb; color: white; font-size: 0.875rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; border: none; cursor: pointer; transition: background-color 0.2s ease; text-align: center; display: inline-flex; align-items: center; justify-content: center; }
    .action-button:hover { background-color: #1d4ed8; }
    .review-button { background-color: #D1D5DB; color: #4B5563; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; transition: background-color 0.2s ease; align-self: center; }
    .review-button:hover { background-color: #9CA3AF; }
    .card-content { flex-grow: 1; }
    .card-actions { margin-top: auto; padding-top: 1rem; }
    .achievement-badge { display: inline-flex; align-items: center; background-color: #FEF3C7; color: #92400E; font-size: 0.8rem; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 500; border: 1px solid #FDE68A; }
    .achievement-badge i { margin-right: 0.4rem; color: #D97706; }
    .favorite-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; color: #d1d5db; font-size: 1.25rem; transition: color 0.2s ease, transform 0.2s ease; } /* Removido position absolute */
    .favorite-btn:hover { transform: scale(1.1); }
    .favorite-btn.favorited { color: #facc15; }
    .favorite-btn i { display: block; }
    .rich-content img { max-width: 100%; height: auto; border-radius: 0.375rem; margin: 0.5rem 0; }
    .rich-content a { color: #2563eb; text-decoration: underline; }
    .rich-content a:hover { color: #1d4ed8; }
    .rich-content ul, .rich-content ol { margin-left: 1.5rem; margin-bottom: 0.5rem; }
    .rich-content blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; margin: 0.5rem 0; color: #4b5563; }
    .announcement-container { margin-bottom: 2rem; transition: all 0.3s ease; }
    .fixed-announcement-box { background-color: #ECFDF5; border: 1px solid #A7F3D0; border-left: 4px solid #10B981; color: #064E3B; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -1px rgba(16, 185, 129, 0.06); position: relative; overflow: hidden; }
    .fixed-announcement-box h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; color: #065F46; }
    .fixed-announcement-box h2 i { margin-right: 0.75rem; color: #10B981; font-size: 1.25rem; }
    .fixed-announcement-item { padding: 0.75rem 0; border-top: 1px dashed rgba(167, 243, 208, 0.7); transition: all 0.3s ease; }
    .fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .fixed-announcement-item:last-child { padding-bottom: 0; }
    .announcement-box { background-color: #FEF9C3; border: 1px solid #FDE68A; border-left: 4px solid #F59E0B; color: #92400E; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1), 0 2px 4px -1px rgba(245, 158, 11, 0.06); position: relative; overflow: hidden; transition: all 0.3s ease; }
    .announcement-box h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; color: #92400E; }
    .announcement-box h2 i { margin-right: 0.75rem; color: #F59E0B; font-size: 1.25rem; }
    .non-fixed-announcement-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-top: 1px dashed rgba(252, 211, 77, 0.7); transition: all 0.3s ease; }
    .non-fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .non-fixed-announcement-item:last-child { padding-bottom: 0; }
    .non-fixed-announcement-item .announcement-content { flex-grow: 1; }
    .mark-seen-checkbox-container { position: relative; min-width: 1.5rem; height: 1.5rem; margin-top: 0.2rem; }
    .mark-seen-checkbox { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    .checkmark { position: absolute; top: 0; left: 0; height: 1.5rem; width: 1.5rem; background-color: #FEF9C3; border: 2px solid #F59E0B; border-radius: 4px; transition: all 0.2s ease; }
    .mark-seen-checkbox:hover ~ .checkmark { background-color: #FDE68A; }
    .mark-seen-checkbox:checked ~ .checkmark { background-color: #F59E0B; border-color: #D97706; }
    .checkmark:after { content: ""; position: absolute; display: none; }
    .mark-seen-checkbox:checked ~ .checkmark:after { display: block; }
    .mark-seen-checkbox-container .checkmark:after { left: 0.45rem; top: 0.2rem; width: 0.35rem; height: 0.7rem; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .mark-seen-checkbox-container .tooltip { visibility: hidden; width: 120px; background-color: rgba(0, 0, 0, 0.8); color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; }
    .mark-seen-checkbox-container:hover .tooltip { visibility: visible; opacity: 1; }
    @keyframes fadeOut { from { opacity: 1; height: auto; margin-top: inherit; margin-bottom: inherit; padding-top: inherit; padding-bottom: inherit; } to { opacity: 0; height: 0; margin-top: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; } }
    .fade-out { animation: fadeOut 0.5s ease forwards; overflow: hidden; }
    .continue-block { background-color: #EFF6FF; border: 1px solid #BFDBFE; border-left: 4px solid #3B82F6; color: #1E40AF; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06); transition: all 0.3s ease; }
    .continue-block:hover { box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1), 0 4px 6px -2px rgba(59, 130, 246, 0.05); transform: translateY(-2px); }
    .continue-block h3 { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: flex; align-items: center; color: #1E40AF; }
    .continue-block h3 i { margin-right: 0.5rem; color: #3B82F6; }
    .continue-block a { font-size: 1.125rem; font-weight: 600; color: #1E3A8A; text-decoration: none; transition: all 0.2s ease; display: block; }
    .continue-block a:hover { color: #3B82F6; text-decoration: underline; }
    .stat-card { background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -2px rgba(0, 0, 0, 0.05); transition: all 0.3s ease-in-out; display: flex; flex-direction: column; height: 100%; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.06); border-color: #60a5fa; }
    .stat-card-title { display: flex; align-items: center; font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
    .stat-card-title i { margin-right: 0.75rem; font-size: 1.25rem; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }
    .progress-card .stat-card-title i { color: #3b82f6; background-color: #eff6ff; }
    .points-card { text-align: center; justify-content: center; background: linear-gradient(145deg, #fffbeb, #fefce8); border-color: #fde68a; }
    .points-card .stat-card-title { justify-content: center; }
    .points-card .stat-card-title i { color: #f59e0b; background-color: #ffffff; }
    .points-display { font-size: 2.75rem; font-weight: 800; color: #d97706; line-height: 1; margin-top: 0.5rem; }
    .achievements-card .stat-card-title i { color: #8b5cf6; background-color: #f5f3ff; }
    .achievements-list { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 0.5rem; }
    .achievements-card .achievement-badge { border: 1px solid transparent; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .filter-container { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
    .filter-label { display: flex; align-items: center; font-size: 0.875rem; font-weight: 500; color: #334155; margin-bottom: 0.5rem; }
    .filter-label i { color: #64748b; margin-right: 0.5rem; width: 16px; text-align: center; }
    .custom-input { width: 100%; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem; font-size: 0.875rem; color: #1e2937; transition: border-color 0.2s ease, box-shadow 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .custom-input::placeholder { color: #94a3b8; }
    .custom-input:focus { outline: none; border-color: #2563eb; background-color: #ffffff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    select.custom-input { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }

    /* --- INÍCIO: NOVOS ESTILOS PARA O ACORDEÃO HIERÁRQUICO --- */
    .accordion-item {
        border-radius: 0.5rem;
        overflow: hidden;
        margin-bottom: 0.75rem;
        background-color: #fff;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03);
    }
    .accordion-header {
        padding: 1rem 1.5rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
    }
    .accordion-header:hover { background-color: #f8fafc; }
    .accordion-header .diploma-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; display: flex; align-items: center; }
    .accordion-header .diploma-title .icon { margin-right: 0.75rem; color: #3b82f6; }
    .accordion-header .diploma-progress { display: flex; align-items: center; gap: 0.75rem; width: 30%; }
    .accordion-content { display: none; /* Controlado por JS */ padding: 0.5rem 1.5rem 1.5rem 1.5rem; border-top: 1px solid #e2e8f0; background-color: #fdfdff; }
    .topic-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px dashed #e2e8f0; }
    .topic-item:last-child { border-bottom: none; }
    .topic-title { display: flex; align-items: center; color: #334155; }
    .topic-title .icon { margin-right: 0.75rem; color: #94a3b8; }
    .topic-actions { display: flex; align-items: center; gap: 0.75rem; }
    .accordion-toggle-icon { transition: transform 0.3s ease; }
    .accordion-header.open .accordion-toggle-icon { transform: rotate(90deg); }

    @media (max-width: 768px) {
        .fixed-announcement-box, .announcement-box { padding: 1rem; }
        .non-fixed-announcement-item { gap: 0.75rem; }
        .fixed-announcement-box h2, .announcement-box h2 { font-size: 1.1rem; }
        .accordion-header .diploma-progress { display: none; } /* Opcional: esconde progresso em telas menores */
    }
</style>
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-8" style="color: #2563eb;">Meu Painel</h1>

{% if last_accessed_law %}
<div class="continue-block">
    <h3><i class="fas fa-history"></i> Continuar de onde parou:</h3>
    <a href="{{ url_for('student.view_law', law_id=last_accessed_law.id) }}">{{ last_accessed_law.parent.title + ' - ' if last_accessed_law.parent else '' }}{{ last_accessed_law.title }}</a>
</div>
{% endif %}
{% if fixed_announcements %}{# ...código dos avisos... #}{% endif %}
{% if non_fixed_announcements %}{# ...código dos avisos... #}{% endif %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">{# ...código das estatísticas... #}</div>
<div class="stat-card achievements-card mb-8">{# ...código das conquistas... #}</div>

<div class="filter-container mb-8">
    <form method="GET" action="{{ url_for('student.dashboard') }}" class="grid grid-cols-1 md:grid-cols-5 gap-6 items-end">
        </form>
</div>

<h2 class="text-2xl font-semibold mb-6" style="color: #2563eb;">Legislações Disponíveis</h2>
<div id="laws-accordion-container">
    {% if subjects_with_diplomas %}
        {% for subject_name, diplomas in subjects_with_diplomas.items() %}
            <div class="mb-6">
                <h3 class="text-lg font-bold text-gray-700 mb-3">{{ subject_name }}</h3>
                {% for diploma in diplomas %}
                <div class="accordion-item">
                    <div class="accordion-header">
                        <div class="diploma-title">
                            <i class="fas fa-gavel icon"></i>
                            <span>{{ diploma.title }}</span>
                        </div>
                        <div class="diploma-progress">
                            <div class="progress-bar-container w-full">
                                <div class="progress-bar-fill" style="width: {{ diploma.progress_percentage | default(0) }}%;"></div>
                            </div>
                            <span class="text-sm font-bold" style="color: #2563eb;">{{ "%.0f"|format(diploma.progress_percentage | default(0)) }}%</span>
                            <i class="fas fa-chevron-right accordion-toggle-icon"></i>
                        </div>
                    </div>
                    <div class="accordion-content">
                        {% for topic in diploma.filtered_children %}
                        <div class="topic-item" data-law-id="{{ topic.id }}">
                            <div class="topic-title">
                                <i class="fas fa-file-alt icon"></i>
                                <span>{{ topic.title }}</span>
                            </div>
                            <div class="topic-actions">
                                {% if topic.id in completed_law_ids %}
                                    <span class="completed-badge">Concluída</span>
                                {% elif topic.id in in_progress_law_ids %}
                                    <span class="in-progress-badge">Em Andamento</span>
                                {% endif %}
                                <a href="{{ url_for('student.view_law', law_id=topic.id) }}" class="action-button">
                                    {% if topic.id in completed_law_ids %}<i class="fas fa-check-circle mr-1"></i> Revisar
                                    {% elif topic.id in in_progress_law_ids %}<i class="fas fa-book-reader mr-1"></i> Continuar
                                    {% else %}<i class="fas fa-book mr-1"></i> Começar{% endif %}
                                </a>
                                <button type="button" class="favorite-btn js-favorite-btn {% if topic.id in favorite_law_ids %}favorited{% endif %}" data-law-id="{{ topic.id }}" title="{% if topic.id in favorite_law_ids %}Remover dos Favoritos{% else %}Adicionar aos Favoritos{% endif %}">
                                    <i class="{% if topic.id in favorite_law_ids %}fas fa-star{% else %}far fa-star{% endif %}"></i>
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-gray-500 italic text-center py-4">Nenhum tópico de estudo encontrado para este diploma com os filtros atuais.</p>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endfor %}
    {% else %}
        <div class="col-span-3 text-center py-8">
            <p class="text-gray-500 italic">Nenhuma legislação encontrada com os filtros selecionados.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- NOVO: SCRIPT PARA CONTROLAR O ACORDEÃO ---
    const accordionHeaders = document.querySelectorAll('.accordion-header');
    accordionHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            this.classList.toggle('open'); // Para o ícone de seta
            if (content.style.display === "block") {
                content.style.display = "none";
            } else {
                content.style.display = "block";
            }
        });
    });

    // --- SEUS SCRIPTS ORIGINAIS (sem alterações) ---

    // BLOCO DE SCRIPT CORRIGIDO PARA "AVISOS RECENTES"
    const markSeenCheckboxes = document.querySelectorAll('.mark-seen-checkbox');
    markSeenCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // ... (seu código original de avisos aqui) ...
        });
    });

    // Bloco de script para "Marcar como não concluído"
    const markIncompleteButtons = document.querySelectorAll('.js-mark-incomplete-btn');
    markIncompleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            // ... (seu código original de marcar como incompleto aqui) ...
        });
    });

    // Favoritar/Desfavoritar lei
    const favoriteButtons = document.querySelectorAll('.js-favorite-btn');
    favoriteButtons.forEach(button => {
        button.addEventListener('click', function() {
            this.disabled = true;
            
            const lawId = this.getAttribute('data-law-id');
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const apiUrl = `/student/law/toggle_favorite/${lawId}`;
            const favoriteBtn = this;
            const icon = this.querySelector('i');
            
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) { throw new Error('Erro ao atualizar favorito'); }
                return response.json();
            })
            .then(data => {
                if (data.favorited === false) {
                    favoriteBtn.classList.remove('favorited');
                    if (icon) { icon.className = 'far fa-star'; favoriteBtn.title = 'Adicionar aos Favoritos'; }
                } else {
                    favoriteBtn.classList.add('favorited');
                    if (icon) { icon.className = 'fas fa-star'; favoriteBtn.title = 'Remover dos Favoritos'; }
                }
            })
            .catch(error => { console.error('Erro:', error); })
            .finally(() => { favoriteBtn.disabled = false; });
        });
    });
});
</script>
{% endblock %}
