{% extends "base.html" %}

{% block title %}Meu Painel - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    /* ===================================================================== */
    /* <<< INÍCIO DAS ALTERAÇÕES DE ESTILO >>> */
    /* ===================================================================== */

    /* Estilos Gerais (sem alterações) */
    .law-card { transition: all 0.3s ease; background-color: #FFFFFF; border: 1px solid #dbeafe; color: #374151; display: flex; flex-direction: column; justify-content: space-between; min-height: 170px; border-radius: 0.75rem; box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05); position: relative; }
    .law-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1), 0 4px 6px -2px rgba(37, 99, 235, 0.05); border-color: #93c5fd; }
    .progress-bar-container { height: 8px; border-radius: 4px; background-color: #e5e7eb; overflow: hidden; flex-grow: 1; }
    .progress-bar-fill { height: 100%; border-radius: 4px; background-color: #2563eb; transition: width 0.5s ease; }
    .completed-badge { background-color: #D1FAE5; color: #065F46; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; }
    .in-progress-badge { background-color: #DBEAFE; color: #1E40AF; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; }
    .action-button { background-color: #2563eb; color: white; font-size: 0.875rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; border: none; cursor: pointer; transition: background-color 0.2s ease; text-align: center; display: inline-flex; align-items: center; justify-content: center; }
    .action-button:hover { background-color: #1d4ed8; }
    .achievement-badge { display: inline-flex; align-items: center; background-color: #FEF3C7; color: #92400E; font-size: 0.8rem; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 500; border: 1px solid #FDE68A; }
    .achievement-badge i { margin-right: 0.4rem; color: #D97706; }
    .favorite-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; color: #d1d5db; font-size: 1.25rem; transition: color 0.2s ease, transform 0.2s ease; }
    .favorite-btn:hover { transform: scale(1.1); }
    .favorite-btn.favorited { color: #facc15; }
    .favorite-btn i { display: block; }
    .rich-content img { max-width: 100%; height: auto; border-radius: 0.375rem; margin: 0.5rem 0; }
    .rich-content a { color: #2563eb; text-decoration: underline; }
    .rich-content a:hover { color: #1d4ed8; }
    .rich-content ul, .rich-content ol { margin-left: 1.5rem; margin-bottom: 0.5rem; }
    .rich-content blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; margin: 0.5rem 0; color: #4b5563; }
    .announcement-container { margin-bottom: 2rem; transition: all 0.3s ease; }

    /* Efeito de elevação adicionado aos cards de aviso */
    .fixed-announcement-box { 
        background-color: #fee2e2; /* Cor de fundo vermelho claro */
        border: 1px solid #fca5a5; /* Borda vermelha mais escura */
        border-left: 4px solid #ef4444; /* Borda esquerda vermelha vibrante */
        color: #991b1b; /* Cor do texto vermelho escuro */
        padding: 1.25rem; 
        border-radius: 0.75rem; 
        margin-bottom: 1.5rem; 
        box-shadow: 0 4px 8px -2px rgba(239, 68, 68, 0.1), 0 2px 4px -2px rgba(239, 68, 68, 0.07); 
        position: relative; 
        overflow: hidden; 
    }
    .announcement-box { background-color: #FEF9C3; border: 1px solid #FDE68A; border-left: 4px solid #F59E0B; color: #92400E; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 8px -2px rgba(245, 158, 11, 0.1), 0 2px 4px -2px rgba(245, 158, 11, 0.07); position: relative; overflow: hidden; transition: all 0.3s ease; }

    .fixed-announcement-box h2 { 
        font-size: 1.1rem; 
        font-weight: 600; 
        margin-bottom: 0.5rem; 
        display: flex; 
        align-items: center; 
        color: #991b1b; /* Cor do título vermelho escuro */
    }
    .fixed-announcement-box h2 i { 
        margin-right: 0.75rem; 
        color: #ef4444; /* Cor do ícone vermelho vibrante */
        font-size: 1.25rem; 
    }
    .fixed-announcement-item { padding: 0.75rem 0; border-top: 1px dashed rgba(252, 165, 165, 0.7); transition: all 0.3s ease; } /* Borda tracejada vermelha */
    .fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .fixed-announcement-item:last-child { padding-bottom: 0; }
    .announcement-box h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; color: #92400E; }
    .announcement-box h2 i { margin-right: 0.75rem; color: #F59E0B; font-size: 1.25rem; }
    .non-fixed-announcement-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-top: 1px dashed rgba(252, 211, 77, 0.7); transition: all 0.3s ease; }
    .non-fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .non-fixed-announcement-item:last-child { padding-bottom: 0; }
    .non-fixed-announcement-item .announcement-content { flex-grow: 1; }
    .mark-seen-checkbox-container { position: relative; min-width: 1.5rem; height: 1.5rem; margin-top: 0.2rem; display: block; cursor: pointer; }
    .mark-seen-checkbox { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    .checkmark { position: absolute; top: 0; left: 0; height: 1.5rem; width: 1.5rem; background-color: #FEF9C3; border: 2px solid #F59E0B; border-radius: 4px; transition: all 0.2s ease; }
    .mark-seen-checkbox:hover ~ .checkmark { background-color: #FDE68A; }
    .mark-seen-checkbox:checked ~ .checkmark { background-color: #F59E0B; border-color: #D97706; }
    .checkmark:after { content: ""; position: absolute; display: none; }
    .mark-seen-checkbox:checked ~ .checkmark:after { display: block; }
    .mark-seen-checkbox-container .checkmark:after { left: 0.45rem; top: 0.2rem; width: 0.35rem; height: 0.7rem; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .mark-seen-checkbox-container .tooltip { visibility: hidden; width: 120px; background-color: rgba(0, 0, 0, 0.8); color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; }
    .mark-seen-checkbox-container:hover .tooltip { visibility: visible; opacity: 1; }
    @keyframes fadeOut { from { opacity: 1; height: auto; } to { opacity: 0; height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; border-width: 0; } }
    .fade-out { animation: fadeOut 0.5s ease forwards; overflow: hidden; }
    
    .recent-activities-card .stat-card-title {
        margin-bottom: 0.75rem;
    }
    .compact-activity-link {
        display: block;
        padding: 0.65rem 0.85rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        border: 1px solid #dbeafe; /* Borda sutil para combinar com o fundo */
        background-color: #ffffff; /* Fundo branco para os links se destacarem */
        text-decoration: none;
    }
    .compact-activity-link:hover {
        background-color: #eff6ff;
        border-color: #bfdbfe;
    }
    .compact-activity-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }
    .compact-activity-title {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 1rem;
    }
    .compact-activity-time {
        font-size: 0.75rem;
        color: #6b7280;
        flex-shrink: 0;
        white-space: nowrap;
    }

    /* Estilo base para todos os cards, com a nova sombra para elevação */
    .stat-card {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-left: 4px solid; /* Adiciona a borda esquerda */
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative; /* Necessário para o border-left */
        overflow: hidden; /* Garante que a sombra não vaze */
    }
    /* Efeito de hover aprimorado para todos os cards */
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.08);
        border-color: #93c5fd; /* Manter a cor da borda ao hover para consistência */
    }

    .stat-card-title { display: flex; align-items: center; font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
    .stat-card-title i { margin-right: 0.75rem; font-size: 1.25rem; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }

    /* Cores e estilos específicos para cada tipo de card, seguindo a nova paleta */

    /* Atividades Recentes */
    .recent-activities-card {
        background-color: #f8f8f8; /* Cinza claro */
        border-color: #e0e0e0;
        border-left-color: #9e9e9e; /* Cinza médio */
        box-shadow: 0 4px 8px -2px rgba(158, 158, 158, 0.1), 0 2px 4px -2px rgba(158, 158, 158, 0.07);
    }
    .recent-activities-card .stat-card-title i {
        color: #757575; /* Cinza escuro */
        background-color: #eeeeee;
    }
    .recent-activities-card:hover {
        border-color: #bdbdbd;
        box-shadow: 0 10px 20px -5px rgba(158, 158, 158, 0.15), 0 4px 6px -4px rgba(158, 158, 158, 0.1);
    }

    /* Sequência de Estudos */
    .streak-card {
        text-align: center;
        justify-content: center;
        background: linear-gradient(145deg, #fff3e0, #fff9f0); /* Laranja/âmbar claro */
        border-color: #ffcc80;
        border-left-color: #ff9800; /* Laranja vibrante */
        box-shadow: 0 4px 8px -2px rgba(255, 152, 0, 0.1), 0 2px 4px -2px rgba(255, 152, 0, 0.07);
    }
    .streak-card .stat-card-title {
        justify-content: center;
    }
    .streak-card .stat-card-title i {
        color: #f57c00; /* Laranja escuro */
        background-color: #fff9e6;
    }
    .streak-display {
        font-size: 2.75rem;
        font-weight: 800;
        color: #ef6c00; /* Laranja ainda mais escuro */
        line-height: 1;
        margin-top: 0.5rem;
    }
    .streak-text {
        font-size: 0.875rem;
        font-weight: 500;
        color: #f97316;
        margin-top: 0.25rem;
    }
    .streak-card:hover {
        border-color: #ffb74d;
        box-shadow: 0 10px 20px -5px rgba(255, 152, 0, 0.15), 0 4px 6px -4px rgba(255, 152, 0, 0.1);
    }

    /* Meu Nível */
    .level-card {
        background: linear-gradient(145deg, #e0f7fa, #f0fcfe); /* Ciano claro */
        border: 1px solid #80deea;
        border-left: 4px solid #00bcd4; /* Ciano vibrante, borda mais grossa */
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 4px 8px -2px rgba(0, 188, 212, 0.1), 0 2px 4px -2px rgba(0, 188, 212, 0.07);
    }
    .level-card .stat-card-title i {
        color: #00838f; /* Ciano escuro */
        background-color: #e0f7fa;
    }
    .level-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .level-icon {
        font-size: 2rem;
        color: #00838f;
    }
    .level-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #006064;
    }
    .level-points {
        font-size: 0.875rem;
        font-weight: 500;
        color: #00838f;
        margin-top: -4px;
    }
    .xp-bar-container {
        height: 12px;
        width: 100%;
        background-color: rgba(0, 188, 212, 0.1);
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid rgba(0, 188, 212, 0.2);
    }
    .xp-bar-fill {
        height: 100%;
        background: linear-gradient(to right, #26c6da, #00bcd4);
        border-radius: 6px;
        transition: width 0.5s ease-in-out;
        box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
    }
    .next-level-info {
        font-size: 0.8rem;
        font-weight: 500;
        color: #00838f;
        text-align: right;
        margin-top: 0.5rem;
    }
    .level-card:hover {
        border-color: #4dd0e1;
        box-shadow: 0 10px 20px -5px rgba(0, 188, 212, 0.15), 0 4px 6px -4px rgba(0, 188, 212, 0.1);
    }
    
    /* Medalhas e Feitos */
    .achievements-card {
        background: linear-gradient(145deg, #ede7f6, #f8f5fb); /* Violeta/lilás claro */
        border-color: #b39ddb;
        border-left-color: #673ab7; /* Violeta vibrante */
        box-shadow: 0 4px 8px -2px rgba(103, 58, 183, 0.1), 0 2px 4px -2px rgba(103, 58, 183, 0.07);
    }
    .achievements-card .stat-card-title i {
        color: #512da8; /* Violeta escuro */
        background-color: #f3e5f5;
    }
    .achievements-list { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 0.5rem; }
    .achievements-card:hover {
        border-color: #9575cd;
        box-shadow: 0 10px 20px -5px rgba(103, 58, 183, 0.15), 0 4px 6px -4px rgba(103, 58, 183, 0.1);
    }

    /* Card de Motivação Diária (Novo) */
    .daily-motivation-card {
        background: linear-gradient(145deg, #f3e5f5, #fcf8fc); /* Roxo claro para o fundo */
        border-color: #ce93d8; /* Borda roxa clara */
        border-left-color: #ab47bc; /* Borda esquerda roxa vibrante */
        box-shadow: 0 4px 8px -2px rgba(171, 71, 188, 0.1), 0 2px 4px -2px rgba(171, 71, 188, 0.07);
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .daily-motivation-card .stat-card-title {
        justify-content: center;
        margin-bottom: 0.5rem;
    }
    .daily-motivation-card .stat-card-title i {
        color: #8e24aa; /* Roxo escuro para o ícone */
        background-color: #fce4ec; /* Fundo do ícone mais claro */
    }
    .daily-motivation-card:hover {
        border-color: #be93d8; /* Borda ao hover */
        box-shadow: 0 10px 20px -5px rgba(171, 71, 188, 0.15), 0 4px 6px -4px rgba(171, 71, 188, 0.1);
    }
    .motivation-date {
        font-size: 0.9rem;
        font-weight: 500;
        color: #8e24aa; /* Cor da data */
        margin-bottom: 0.75rem;
    }
    .motivation-text {
        font-size: 1.15rem; /* Frase um pouco maior */
        font-style: italic;
        color: #7b1fa2; /* Roxo mais escuro para a frase */
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.5rem;
    }

    /* ===================================================================== */
    /* NOVO DESIGN DO SISTEMA DE FILTROS - MAIS MODERNO E ORGANIZADO */
    /* ===================================================================== */

    /* Container principal dos filtros com design moderno */
    .modern-filter-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.25), 0 10px 10px -5px rgba(102, 126, 234, 0.04);
        position: relative;
        overflow: hidden;
    }

    /* Efeito de overlay sutil */
    .modern-filter-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        z-index: 1;
    }

    /* Conteúdo dos filtros */
    .filter-content {
        position: relative;
        z-index: 2;
    }

    /* Título da seção de filtros */
    .filter-section-title {
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filter-section-title i {
        margin-right: 0.75rem;
        font-size: 1.75rem;
        color: #fbbf24;
    }

    /* Container da busca principal */
    .search-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(10px);
    }

    /* Estilo da busca principal */
    .search-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-label {
        display: block;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
    }

    .search-label i {
        margin-right: 0.5rem;
        color: #6366f1;
        font-size: 1.1rem;
    }

    .modern-search-input {
        width: 100%;
        background-color: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem 1rem 1rem 3rem;
        font-size: 1rem;
        color: #111827;
        transition: all 0.3s ease;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .modern-search-input:focus {
        outline: none;
        border-color: #6366f1;
        background-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transform: translateY(-1px);
    }

    .modern-search-input::placeholder {
        color: #9ca3af;
        font-style: italic;
    }

    .search-icon {
        position: absolute;
        top: 50%;
        left: 1rem;
        transform: translateY(-50%);
        color: #6b7280;
        font-size: 1.1rem;
        transition: color 0.3s ease;
    }

    .modern-search-input:focus + .search-icon {
        color: #6366f1;
    }

    /* Checkbox de favoritos */
    .favorites-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(99, 102, 241, 0.1);
        border: 2px solid rgba(99, 102, 241, 0.2);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .favorites-checkbox:hover {
        background: rgba(99, 102, 241, 0.15);
        border-color: rgba(99, 102, 241, 0.3);
    }

    .favorites-checkbox input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 1.25rem;
        height: 1.25rem;
        accent-color: #6366f1;
    }

    .favorites-checkbox label {
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        margin: 0;
    }

    /* Seção de filtros organizados */
    .filters-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(10px);
    }

    /* Grid dos filtros */
    .filters-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    @media (min-width: 768px) {
        .filters-grid {
            grid-template-columns: 2fr 3fr 1fr;
        }
    }

    /* Grupos de filtros */
    .filter-group {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 1.25rem;
        transition: all 0.3s ease;
    }

    .filter-group:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
    }

    .filter-group-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .filter-group-title i {
        margin-right: 0.5rem;
        color: #6366f1;
        font-size: 1.1rem;
    }

    /* Inputs dos filtros */
    .modern-filter-input {
        width: 100%;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #111827;
        transition: all 0.3s ease;
        margin-bottom: 0.75rem;
    }

    .modern-filter-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .modern-filter-input:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
    }

    /* Select customizado */
    select.modern-filter-input {
        background-image: url("data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3e%3cpath stroke=\'%236b7280\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'M6 8l4 4 4-4\'%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        appearance: none;
    }

    /* Refinamento de filtros */
    .refinement-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .refinement-options {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    .refinement-option {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .refinement-option input[type="radio"] {
        margin-right: 0.5rem;
        accent-color: #6366f1;
    }

    .refinement-option label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        margin: 0;
    }

    /* Botão de limpar filtros */
    .clear-filters-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px -1px rgba(239, 68, 68, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    .clear-filters-btn:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.25);
    }

    .clear-filters-btn i {
        margin-right: 0.5rem;
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .modern-filter-container {
            padding: 1.5rem;
        }
        
        .filter-section-title {
            font-size: 1.25rem;
        }
        
        .search-section,
        .filters-section {
            padding: 1rem;
        }
        
        .refinement-options {
            flex-direction: column;
            gap: 0.5rem;
        }
    }

    /* Animações */
    @keyframes filterSlideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .filter-group {
        animation: filterSlideIn 0.3s ease-out;
    }

    /* Estados de loading */
    .loading-state {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }

    .loading-state::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #6366f1;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* ===================================================================== */
    /* FIM DO NOVO DESIGN DO SISTEMA DE FILTROS */
    /* ===================================================================== */

    /* Estilos para ocultar/mostrar cards */
    .hidden-card-section {
        display: none;
    }

    @media (max-width: 768px) {
        .fixed-announcement-box, .announcement-box { padding: 1rem; }
        .non-fixed-announcement-item { gap: 0.75rem; }
        .fixed-announcement-box h2, .announcement-box h2 { font-size: 1.1rem; }
        .accordion-header .diploma-progress { display: none; }
    }
    
    /* INÍCIO: Estilo para o botão de editar título dos favoritos */
    #edit-favorites-title-btn {
        background: none;
        border: none;
        color: #9ca3af; /* Cinza claro */
        cursor: pointer;
        margin-left: 0.75rem;
        font-size: 0.9rem;
        padding: 0.25rem;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
        transition: all 0.2s ease;
    }
    #edit-favorites-title-btn:hover {
        color: #4b5563; /* Cinza mais escuro */
        background-color: #f3f4f6; /* Fundo cinza claro no hover */
    }
    /* FIM: Estilo para o botão de editar título dos favoritos */

    /* ===================================================================== */
    /* <<< FIM DAS ALTERAÇÕES DE ESTILO >>> */
    /* ===================================================================== */
</style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex items-center justify-between"> {# Adiciona um contêiner flex para o título e o botão #}
        <h1 class="text-3xl font-bold text-gray-800">Meu Painel</h1>
        {# Botão de Ocultar Cards - Adicionado aqui #}
        <button id="toggle-cards-btn" class="action-button">
            <i class="fas fa-eye-slash mr-2"></i> Ocultar Cards
        </button>
    </div>

    {% if fixed_announcements or non_fixed_announcements %}
    <div class="announcement-section" id="announcement-cards-section"> {# Adicionado ID para a seção de avisos #}
        {% if fixed_announcements %}
        <div class="announcement-container">
            <div class="fixed-announcement-box">
                {% for announcement in fixed_announcements %}
                <div class="fixed-announcement-item {% if not loop.first %}mt-3{% endif %}">
                    <h2><i class="fas fa-thumbtack"></i>{{ announcement.title }}</h2>
                    <div class="announcement-content rich-content">{{ announcement.content|safe }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% if non_fixed_announcements %}
        <div class="announcement-container" id="non-fixed-announcements-container">
            <div class="announcement-box">
                <h2><i class="fas fa-bullhorn"></i> Avisos Recentes</h2>
                {% for announcement in non_fixed_announcements %}
                <div class="non-fixed-announcement-item" data-announcement-id="{{ announcement.id }}">
                    <label class="mark-seen-checkbox-container">
                        <input type="checkbox" class="mark-seen-checkbox">
                        <span class="checkmark"></span>
                        <span class="tooltip">Marcar como visto</span>
                    </label>
                    <div class="announcement-content">
                        <h3 class="text-md font-semibold">{{ announcement.title }}</h3>
                        <div class="text-sm rich-content">{{ announcement.content|safe }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# ===================================================================== #}
    {# <<< INÍCIO DA IMPLEMENTAÇÃO: ALTERAÇÃO DA ESTRUTURA DOS CARDS >>> #}
    {# ===================================================================== #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="main-cards-grid"> {# Adicionado ID para o grid principal dos cards #}
        {# Meu Diário (primeira coluna, ocupa 2 linhas) #}
        <div class="stat-card todo-list-card md:row-span-2"> 
            <h2 class="stat-card-title"><i class="fas fa-sticky-note"></i> Post-It</h2> {# Alterado o nome do card e o ícone #}
            <div class="todo-input-container">
                <input type="text" id="new-todo-item" placeholder="Adicionar nova tarefa..." class="custom-input">
                <button id="add-todo-btn" class="action-button">Adicionar</button>
            </div>
            <ul id="todo-list" class="space-y-1 flex-grow" style="max-height: 400px; overflow-y: hidden;"> {# Alterado de 'auto' para 'hidden' #}
                {# Os itens serão carregados e renderizados via JavaScript #}
                {% if todo_items %}
                    {% for item in todo_items %}
                        <li class="todo-item {% if item.is_completed %}completed{% endif %}" data-item-id="{{ item.id }}">
                            <label class="todo-item-content">
                                <input type="checkbox" class="todo-checkbox" {% if item.is_completed %}checked{% endif %}>
                                {# Modificação para limitar o texto e adicionar tooltip #}
                                <span class="todo-item-text">{{ item.content|truncate(40, True) }}</span>
                                <span class="todo-item-text-tooltip">{{ item.content }}</span>
                            </label>
                            <div class="todo-actions">
                                <button type="button" class="todo-delete-btn" title="Excluir tarefa">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </li>
                    {% endfor %}
                {% else %}
                    <p id="no-todo-items-message" class="text-gray-500 italic text-sm text-center py-4">Nenhuma tarefa por enquanto. Adicione uma!</p>
                {% endif %}
            </ul>
        </div>

        {# Atividades Recentes (segunda coluna, primeira linha) #}
        {% if recent_activities %}
        <div class="stat-card recent-activities-card" id="recent-activities-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-history"></i> Atividades Recentes</h2>
            <div class="flex flex-col space-y-2">
                {% for activity in recent_activities %}
                <a href="{{ url_for('student.view_law', law_id=activity.law.id) }}" class="compact-activity-link">
                    <div class="compact-activity-content">
                        <span class="compact-activity-title" title="{{ activity.law.parent.title + ' - ' if activity.law.parent else '' }}{{ activity.law.title }}">
                            {{ activity.law.parent.title + ' - ' if activity.law.parent else '' }}{{ activity.law.title }}
                        </span>
                        <span class="compact-activity-time">{{ activity.time_ago }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {# Motivação Diária (NOVO CARD - terceira coluna, primeira linha) #}
        <div class="stat-card daily-motivation-card" id="daily-motivation-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-brain"></i> Motivação Diária</h2>
            <div id="motivation-date" class="motivation-date"></div>
            <p id="motivation-text" class="motivation-text"></p>
        </div>

        {# Sequência de Estudos (segunda coluna, segunda linha) #}
        <div class="stat-card streak-card" id="streak-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-fire"></i> Sequência de Estudos</h2>
            {% if user_streak > 0 %}
                <div class="streak-display">{{ user_streak }}</div>
                <p class="streak-text">dias consecutivos!</p>
            {% else %}
                <p class="text-gray-500 italic mt-2">Estude hoje para começar uma nova sequência! 🔥</p>
            {% endif %}
        </div>

        {# Meu Nível (terceira coluna, segunda linha) #}
        <div class="stat-card level-card" id="level-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-gem"></i> Meu Nível</h2>
            <div class="level-info">
                <i class="{{ level_info.current_level.icon }} level-icon"></i>
                <div>
                    <div class="level-name">{{ level_info.current_level.name }}</div>
                    <div class="level-points">{{ user_points }} pontos</div>
                </div>
            </div>
            <div class="xp-bar-container">
                <div class="xp-bar-fill" style="width: {{ '%.2f'|format(level_info.progress_percent) }}%;"></div>
            </div>
            {% if level_info.next_level %}
                <p class="next-level-info">
                    Faltam <strong>{{ level_info.points_to_next }}</strong> pontos para <i class="{{ level_info.next_level.icon }}"></i> <strong>{{ level_info.next_level.name }}</strong>
                </p>
            {% else %}
                <p class="next-level-info">Parabéns! Você alcançou o nível máximo!</p>
            {% endif %}
        </div>
    </div>
    {# ===================================================================== #}
    {# <<< FIM DA IMPLEMENTAÇÃO: ALTERAÇÃO DA ESTRUTURA DOS CARDS >>> #}
    {# ===================================================================== #}
    
    <div class="stat-card achievements-card" id="achievements-card"> {# Adicionado ID #}
        <h2 class="stat-card-title"><i class="fas fa-trophy"></i> Medalhas e Feitos</h2>
        {% if user_achievements %}
            <div class="achievements-list">
                {% for achievement in user_achievements %}
                    <span class="achievement-badge" title="{{ achievement.description }}">
                        <i class="{{ achievement.icon or 'fas fa-trophy' }}"></i> {{ achievement.name }}
                    </span>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-500 italic mt-2">Você ainda não desbloqueou nenhuma medalha. Continue estudando!</p>
        {% endif %}
    </div>

    {# ===================================================================== #}
    {# NOVO SISTEMA DE FILTROS MODERNO E ORGANIZADO #}
    {# ===================================================================== #}
    <div class="modern-filter-container">
        <div class="filter-content">
            <h2 class="filter-section-title">
                <i class="fas fa-search"></i>
                Sistema de Busca Inteligente
            </h2>
            
            {# Seção de Busca Principal #}
            <div class="search-section">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
                    <div class="lg:col-span-3">
                        <label class="search-label">
                            <i class="fas fa-search"></i>
                            Busca Rápida e Inteligente
                        </label>
                        <div class="search-wrapper">
                            <input type="text" id="search" name="search" placeholder="Digite o nome da matéria, lei ou artigo que você procura..." class="modern-search-input">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <div id="autocomplete-results" class="autocomplete-container"></div>
                    </div>
                    <div class="favorites-checkbox">
                        <input type="checkbox" id="show_favorites" name="show_favorites">
                        <label for="show_favorites">Apenas favoritas</label>
                    </div>
                </div>
            </div>

            {# Seção de Filtros Organizados #}
            <div class="filters-section">
                <div class="filters-grid">
                    {# Grupo 1: Filtro por Concurso (Separado) #}
                    <div class="filter-group">
                        <div class="filter-group-title">
                            <i class="fas fa-trophy"></i>
                            Concurso
                        </div>
                        <select id="concurso_id" name="concurso_id" class="modern-filter-input">
                            <option value="all" selected>Todos os Concursos</option>
                            {% for concurso in concursos %}
                                <option value="{{ concurso.id }}">{{ concurso.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Grupo 2: Matéria e Lei (Juntos) #}
                    <div class="filter-group">
                        <div class="filter-group-title">
                            <i class="fas fa-book-open"></i>
                            Matéria & Lei
                        </div>
                        <select id="subject_id" name="subject_id" class="modern-filter-input">
                        {% if favorites_by_subject %}
                            <option value="" selected>Favoritas</option>
                            <option value="all">Todas as Matérias</option>
                        {% else %}
                            <option value="all" selected>Todas as Matérias</option>
                        {% endif %}
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                        </select>
                        
                        <select id="diploma_id" name="diploma_id" class="modern-filter-input" disabled>
                            <option value="">Selecione uma Matéria</option>
                        </select>

                        {# Refinamento #}
                        <div class="refinement-section" id="refinement-wrapper" style="visibility: hidden;">
                            <div class="refinement-options">
                                <div class="refinement-option">
                                    <input type="radio" name="refine_type" value="status" id="refine-status" checked>
                                    <label for="refine-status">Por Status</label>
                                </div>
                                <div class="refinement-option">
                                    <input type="radio" name="refine_type" value="topic" id="refine-topic">
                                    <label for="refine-topic">Por Trecho</label>
                                </div>
                            </div>
                            
                            <div id="status-filter-wrapper">
                                <select id="status_filter" name="status_filter" class="modern-filter-input">
                                    <option value="">Todos os Status</option>
                                    <option value="not_read">Não Lidas</option>
                                    <option value="in_progress">Em Andamento</option>
                                    <option value="completed">Concluídas</option>
                                </select>
                            </div>
                            
                            <div id="topic-filter-wrapper" style="display: none;">
                                <select id="topic_filter" name="topic_filter" class="modern-filter-input" disabled>
                                    <option value="">Selecione um Trecho</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {# Grupo 3: Ações #}
                    <div class="filter-group">
                        <div class="filter-group-title">
                            <i class="fas fa-tools"></i>
                            Ações
                        </div>
                        <button type="button" id="clear-filters-btn" class="clear-filters-btn">
                            <i class="fas fa-eraser"></i>
                            Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {# ===================================================================== #}
    {# FIM DO NOVO SISTEMA DE FILTROS #}
    {# ===================================================================== #}

    <div id="laws-section" style="display: none; opacity: 0; transition: opacity 0.5s ease-in-out;">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Legislações Disponíveis</h2>
        <div id="laws-accordion-container"></div>
    </div>

    <div id="initial-prompt">
    
        {% if favorites_by_subject %}
            <div class="text-center mb-10">
                <h2 class="text-2xl font-semibold text-gray-800 flex items-center justify-center">
                    <i class="fas fa-star text-yellow-400 mr-3"></i>
                    <span id="favorites-title-text">{{ custom_favorite_title or 'Acesso Rápido aos Seus Favoritos' }}</span>
                    <button id="edit-favorites-title-btn" title="Renomear esta seção">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </h2>
            </div>

            <div id="favorite-cards-container">
                {% for subject, cards in favorites_by_subject.items()|sort(attribute='0.name') %}
                    <div class="subject-accordion-item">
                        <div class="subject-accordion-header">
                            <h3>{{ subject.name }}</h3>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="subject-accordion-content">
                            <div class="favorites-grid-container">
                                {% for card in cards|sort(attribute='parent.title') %}
                                    <div class="favorite-card">
                                        <div class="favorite-card-header">
                                            <div class="favorite-card-header-title">
                                                <span>{{ card.parent.title }}</span>
                                                <i class="fas fa-chevron-down toggle-icon"></i>
                                            </div>
                                            <div class="favorite-card-progress">
                                                <div class="progress-bar-container">
                                                    <div class="progress-bar-fill" style="width: {{ card.progress }}%;"></div>
                                                </div>
                                                <span class="progress-percentage">{{ "%.0f"|format(card.progress) }}%</span>
                                            </div>
                                        </div>
                                        <div class="favorite-card-body">
                                            {# ===================================================================== #}
                                            {# <<< ALTERAÇÃO APLICADA AQUI: Adicionado |sort(attribute='title') >>> #}
                                            {# ===================================================================== #}
                                            {% for topic in card.topics|sort(attribute='title') %}
                                                <div class="topic-item" data-law-id="{{ topic.id }}">
                                                    <div class="topic-title">
                                                        <i class="fas fa-file-alt icon"></i>
                                                        <span>{{ topic.title }}</span>
                                                    </div>
                                                    <div class="topic-actions">
                                                        {% if topic.is_completed %}
                                                            <span class="completed-badge">Concluída</span>
                                                        {% elif topic.is_in_progress %}
                                                            <span class="in-progress-badge">Em Andamento</span>
                                                        {% else %}
                                                            <i class="fas fa-book-reader mr-1"></i> Continuar
                                                        {% else %}
                                                            <i class="fas fa-book mr-1"></i> Começar
                                                        {% endif %}
                                                        <a href="{{ url_for('student.view_law', law_id=topic.id) }}" class="action-button">
                                                            {% if topic.is_completed %}
                                                                <i class="fas fa-check-circle mr-1"></i> Revisar
                                                            {% elif topic.is_in_progress %}
                                                                <i class="fas fa-book-reader mr-1"></i> Continuar
                                                            {% else %}
                                                                <i class="fas fa-book mr-1"></i> Começar
                                                            {% endif %}
                                                        </a>
                                                        {% if topic.is_completed %}
                                                        <button type="button" class="review-button js-mark-incomplete-btn" data-law-id="{{ topic.id }}" title="Marcar como não concluído">
                                                            <i class="fas fa-undo-alt"></i>
                                                        </button>
                                                        {% endif %}
                                                        <button type="button" class="favorite-btn js-favorite-btn favorited" data-law-id="{{ topic.id }}" title="Remover dos Favoritos">
                                                            <i class="fas fa-star"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <div class="text-center py-12 px-6 bg-white rounded-lg border border-dashed">
                <i class="fas fa-filter text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700">Comece seus estudos!</h3>
                <p class="text-gray-500 mt-2">Selecione uma matéria nos filtros acima para ver as legislações disponíveis.</p>
            </div>
        {% endif %}
        </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DO DOM ---
    const filterControls = {
        search: document.getElementById('search'),
        concurso: document.getElementById('concurso_id'),
        subject: document.getElementById('subject_id'),
        diploma: document.getElementById('diploma_id'),
        statusFilter: document.getElementById('status_filter'),
        topicFilter: document.getElementById('topic_filter'),
        showFavorites: document.getElementById('show_favorites'),
        clearBtn: document.getElementById('clear-filters-btn')
    };

    const refinementWrapper = document.getElementById('refinement-wrapper');
    const statusFilterWrapper = document.getElementById('status-filter-wrapper');
    const topicFilterWrapper = document.getElementById('topic-filter-wrapper');
    const refineTypeRadios = document.querySelectorAll('input[name="refine_type"]');
    
    const lawsSection = document.getElementById('laws-section');
    const lawsContainer = document.getElementById('laws-accordion-container');
    const autocompleteContainer = document.getElementById('autocomplete-results');
    const initialPrompt = document.getElementById('initial-prompt');

    // --- FUNCIONALIDADES EXISTENTES (mantidas) ---
    // Função para buscar e renderizar leis
    async function fetchAndRenderLaws(filters) {
        showLoadingState(lawsSection);
        try {
            const response = await fetch('/student/filter_laws', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filters)
            });
            const data = await response.json();
            renderLaws(data.laws);
            if (data.laws.length > 0) {
                fadeIn(lawsSection);
                fadeOut(initialPrompt);
            } else {
                fadeOut(lawsSection);
                fadeIn(initialPrompt);
            }
        } catch (error) {
            console.error('Erro ao buscar leis:', error);
            Toastify({
                text: 'Erro ao carregar leis. Tente novamente.',
                duration: 3000,
                close: true,
                gravity: 'top',
                position: 'right',
                backgroundColor: 'linear-gradient(to right, #ff416c, #ff4b2b)',
            }).showToast();
        } finally {
            hideLoadingState(lawsSection);
        }
    }

    // Função para renderizar as leis
    function renderLaws(laws) {
        lawsContainer.innerHTML = '';
        if (laws.length === 0) {
            lawsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4">Nenhuma legislação encontrada com os filtros aplicados.</p>';
            return;
        }

        laws.forEach(law => {
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            accordionItem.innerHTML = `
                <div class="accordion-header" data-diploma-id="${law.id}">
                    <div class="diploma-title">
                        <i class="fas fa-gavel icon"></i>
                        ${law.title}
                    </div>
                    <div class="diploma-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${law.progress}%;"></div>
                        </div>
                        <span class="text-sm font-semibold text-blue-600">${law.progress}%</span>
                        <i class="fas fa-chevron-right accordion-toggle-icon"></i>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="space-y-2"></div>
                </div>
            `;
            lawsContainer.appendChild(accordionItem);
        });

        // Adicionar event listeners para os headers do acordeão
        lawsContainer.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', async function() {
                const diplomaId = this.dataset.diplomaId;
                const content = this.nextElementSibling.querySelector('div');
                const toggleIcon = this.querySelector('.accordion-toggle-icon');

                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    this.classList.remove('open');
                    toggleIcon.style.transform = 'rotate(0deg)';
                } else {
                    // Carregar tópicos apenas uma vez
                    if (content.children.length === 0) {
                        try {
                            const response = await fetch('/student/get_topics_by_diploma/'+ diplomaId);
                            const data = await response.json();
                            data.topics.sort((a, b) => a.title.localeCompare(b.title)); // Ordenar por título
                            data.topics.forEach(topic => {
                                const topicItem = document.createElement('div');
                                topicItem.className = 'topic-item';
                                topicItem.dataset.lawId = topic.id;
                                topicItem.innerHTML = `
                                    <div class="topic-title">
                                        <i class="fas fa-file-alt icon"></i>
                                        <span>${topic.title}</span>
                                    </div>
                                    <div class="topic-actions">
                                        ${topic.is_completed ? '<span class="completed-badge">Concluída</span>' : ''}
                                        ${topic.is_in_progress ? '<span class="in-progress-badge">Em Andamento</span>' : ''}
                                        <a href="${topic.view_url}" class="action-button">
                                            ${topic.is_completed ? '<i class="fas fa-check-circle mr-1"></i> Revisar' : ''}
                                            ${topic.is_in_progress ? '<i class="fas fa-book-reader mr-1"></i> Continuar' : ''}
                                            ${!topic.is_completed && !topic.is_in_progress ? '<i class="fas fa-book mr-1"></i> Começar' : ''}
                                        </a>
                                        ${topic.is_completed ? `<button type="button" class="review-button js-mark-incomplete-btn" data-law-id="${topic.id}" title="Marcar como não concluído">
                                            <i class="fas fa-undo-alt"></i>
                                        </button>` : ''}
                                        <button type="button" class="favorite-btn js-favorite-btn ${topic.is_favorite ? 'favorited' : ''}" data-law-id="${topic.id}" title="${topic.is_favorite ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos'}">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                `;
                                content.appendChild(topicItem);
                            });
                            addFavoriteButtonListeners();
                            addMarkIncompleteButtonListeners();
                        } catch (error) {
                            console.error('Erro ao carregar tópicos:', error);
                            Toastify({
                                text: 'Erro ao carregar tópicos. Tente novamente.',
                                duration: 3000,
                                close: true,
                                gravity: 'top',
                                position: 'right',
                                backgroundColor: 'linear-gradient(to right, #ff416c, #ff4b2b)',
                            }).showToast();
                        }
                    }
                    content.style.display = 'block';
                    this.classList.add('open');
                    toggleIcon.style.transform = 'rotate(90deg)';
                }
            });
        });
    }

    // Função para aplicar filtros
    function applyFilters() {
        const filters = {
            search_query: filterControls.search.value,
            concurso_id: filterControls.concurso.value,
            subject_id: filterControls.subject.value,
            diploma_id: filterControls.diploma.value,
            show_favorites: filterControls.showFavorites.checked
        };

        const selectedRefineType = document.querySelector('input[name="refine_type"]:checked');
        if (selectedRefineType) {
            if (selectedRefineType.value === 'status') {
                filters.status_filter = filterControls.statusFilter.value;
            } else if (selectedRefineType.value === 'topic') {
                filters.topic_filter = filterControls.topicFilter.value;
            }
        }
        fetchAndRenderLaws(filters);
    }

    // Event Listeners para os controles de filtro
    filterControls.search.addEventListener('input', applyFilters);
    filterControls.concurso.addEventListener('change', applyFilters);
    filterControls.subject.addEventListener('change', function() {
        applyFilters();
        const subjectId = this.value;
        if (subjectId && subjectId !== 'all') {
            // Habilitar e carregar diplomas
            filterControls.diploma.disabled = false;
            fetch('/student/get_diplomas_by_subject/'+ subjectId)
                .then(response => response.json())
                .then(data => {
                    filterControls.diploma.innerHTML = '<option value="">-- Todas as Leis --</option>';
                    data.diplomas.sort((a, b) => a.name.localeCompare(b.name)); // Ordenar por nome
                    data.diplomas.forEach(diploma => {
                        const option = document.createElement('option');
                        option.value = diploma.id;
                        option.textContent = diploma.name;
                        filterControls.diploma.appendChild(option);
                    });
                    refinementWrapper.style.visibility = 'visible';
                })
                .catch(error => {
                    console.error('Erro ao carregar leis por matéria:', error);
                    filterControls.diploma.innerHTML = '<option value="">Erro ao carregar</option>';
                    refinementWrapper.style.visibility = 'hidden';
                });
        } else {
            filterControls.diploma.disabled = true;
            filterControls.diploma.innerHTML = '<option value="">Selecione uma Matéria</option>';
            refinementWrapper.style.visibility = 'hidden';
        }
    });
    filterControls.diploma.addEventListener('change', function() {
        applyFilters();
        const diplomaId = this.value;
        if (diplomaId && diplomaId !== 'all') {
            // Habilitar e carregar tópicos
            filterControls.topicFilter.disabled = false;
            fetch('/student/get_topics_by_diploma/'+ diplomaId)
                .then(response => response.json())
                .then(data => {
                    filterControls.topicFilter.innerHTML = '<option value="">-- Todos os Trechos --</option>';
                    data.topics.sort((a, b) => a.title.localeCompare(b.title)); // Ordenar por título
                    data.topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.id;
                        option.textContent = topic.title;
                        filterControls.topicFilter.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar trechos por lei:', error);
                    filterControls.topicFilter.innerHTML = '<option value="">Erro ao carregar</option>';
                });
        } else {
            filterControls.topicFilter.disabled = true;
            filterControls.topicFilter.innerHTML = '<option value="">Selecione um Trecho</option>';
        }
    });
    filterControls.statusFilter.addEventListener('change', applyFilters);
    filterControls.topicFilter.addEventListener('change', applyFilters);
    filterControls.showFavorites.addEventListener('change', applyFilters);
    filterControls.clearBtn.addEventListener('click', function() {
        filterControls.search.value = '';
        filterControls.concurso.value = 'all';
        filterControls.subject.value = filterControls.showFavorites.checked ? '' : 'all';
        filterControls.diploma.value = '';
        filterControls.diploma.disabled = true;
        filterControls.statusFilter.value = '';
        filterControls.topicFilter.value = '';
        filterControls.topicFilter.disabled = true;
        filterControls.showFavorites.checked = false;
        document.getElementById('refine-status').checked = true; // Resetar para status
        statusFilterWrapper.style.display = 'block';
        topicFilterWrapper.style.display = 'none';
        refinementWrapper.style.visibility = 'hidden';
        applyFilters();
        fadeOut(lawsSection);
        fadeIn(initialPrompt);
    });

    // Autocomplete
    let autocompleteTimeout;
    filterControls.search.addEventListener('input', function() {
        clearTimeout(autocompleteTimeout);
        const query = this.value;
        if (query.length < 3) {
            autocompleteContainer.style.display = 'none';
            return;
        }
        autocompleteTimeout = setTimeout(async () => {
            try {
                const response = await fetch('/student/autocomplete_search?query=' + query);
                const results = await response.json();
                renderAutocomplete(results);
            } catch (error) {
                console.error('Erro no autocomplete:', error);
            }
        }, 300);
    });

    function renderAutocomplete(results) {
        autocompleteContainer.innerHTML = '';
        if (results.length === 0) {
            autocompleteContainer.style.display = 'none';
            return;
        }
        results.forEach(item => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.innerHTML = `
                <span class="autocomplete-item-title">${item.title}</span>
                <span class="autocomplete-item-category">${item.category}</span>
            `;
            div.addEventListener('click', () => {
                filterControls.search.value = item.title;
                autocompleteContainer.style.display = 'none';
                applyFilters();
            });
            autocompleteContainer.appendChild(div);
        });
        autocompleteContainer.style.display = 'block';
    }

    document.addEventListener('click', function(event) {
        if (!autocompleteContainer.contains(event.target) && event.target !== filterControls.search) {
            autocompleteContainer.style.display = 'none';
        }
    });

    // Funcionalidade de Favoritos
    function addFavoriteButtonListeners() {
        document.querySelectorAll(".js-favorite-btn").forEach(btn => {
            btn.addEventListener('click', function() {
                const lawId = this.dataset.lawId;
                const isFavorited = this.classList.contains('favorited');
                fetch('/student/toggle_favorite/' + lawId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ is_favorite: !isFavorited })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.classList.toggle('favorited');
                        this.title = this.classList.contains('favorited') ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos';
                        Toastify({
                            text: data.message,
                            duration: 2000,
                            close: true,
                            gravity: 'top',
                            position: 'right',
                            backgroundColor: 'linear-gradient(to right, #00b09b, #96c93d)'
                        }).showToast();
                        // Atualizar a seção de favoritos se estiver visível
                        if (document.getElementById('favorite-cards-container')) {
                            // Idealmente, recarregar apenas a seção de favoritos ou atualizar dinamicamente
                            // Para simplificar, pode-se recarregar a página ou os filtros
                            applyFilters(); // Re-aplica os filtros para atualizar a lista, se necessário
                        }
                    } else {
                        Toastify({
                            text: data.message || 'Erro ao atualizar favorito.',
                            duration: 3000,
                            close: true,
                            gravity: 'top',
                            position: 'right',
                            backgroundColor: 'linear-gradient(to right, #ff416c, #ff4b2b)'
                        }).showToast();
                    }
                })
                .catch(error => console.error('Erro ao favoritar:', error));
            });
        });
    }
    addFavoriteButtonListeners(); // Para os favoritos iniciais

    // Marcar como não concluído
    function addMarkIncompleteButtonListeners() {
        document.querySelectorAll(".js-mark-incomplete-btn").forEach(btn => {
            btn.addEventListener('click', function() {
                const lawId = this.dataset.lawId;
                fetch('/student/mark_law_incomplete/' + lawId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Toastify({
                            text: 'Lei marcada como não concluída.',
                            duration: 2000,
                            backgroundColor: 'linear-gradient(to right, #00b09b, #96c93d)'
                        }).showToast();
                        // Atualizar a UI (remover badges, mudar botão, etc.)
                        // Esta parte pode ser mais complexa dependendo de como a UI é estruturada
                        applyFilters(); // Recarregar para refletir a mudança
                    } else {
                        Toastify({ text: 'Erro ao marcar como não concluída.', duration: 3000, backgroundColor: 'red' }).showToast();
                    }
                })
                .catch(error => console.error('Erro ao marcar como não concluído:', error));
            });
        });
    }
    addMarkIncompleteButtonListeners();

    // Acordeão para matérias favoritas
    document.querySelectorAll(".subject-accordion-header").forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            const icon = this.querySelector(".toggle-icon");
            this.classList.toggle('open');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        });
    });

    // Acordeão para cards de favoritos dentro das matérias
    document.querySelectorAll(".favorite-card-header").forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            const icon = this.querySelector(".toggle-icon");
            this.classList.toggle('open');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        });
    });

    // Editar título dos favoritos
    const editFavoritesTitleBtn = document.getElementById('edit-favorites-title-btn');
    const favoritesTitleText = document.getElementById('favorites-title-text');
    if (editFavoritesTitleBtn && favoritesTitleText) {
        editFavoritesTitleBtn.addEventListener('click', function() {
            const currentTitle = favoritesTitleText.textContent;
            const newTitle = prompt('Digite o novo título para seus favoritos:', currentTitle);
            if (newTitle && newTitle.trim() !== '') {
                fetch('/student/update_custom_favorite_title', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ title: newTitle.trim() })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        favoritesTitleText.textContent = newTitle.trim();
                        Toastify({ text: 'Título atualizado com sucesso!', duration: 2000, backgroundColor: '#4CAF50' }).showToast();
                    } else {
                        Toastify({ text: data.message || 'Erro ao atualizar título.', duration: 3000, backgroundColor: '#F44336' }).showToast();
                    }
                })
                .catch(error => {
                    console.error('Erro ao atualizar título:', error);
                    Toastify({ text: 'Erro de comunicação com o servidor.', duration: 3000, backgroundColor: '#F44336' }).showToast();
                });
            }
        });
    }

    // Ocultar/Mostrar Cards
    const toggleCardsBtn = document.getElementById('toggle-cards-btn');
    const mainCardsGrid = document.getElementById('main-cards-grid');
    const achievementsCard = document.getElementById('achievements-card');
    const announcementSection = document.getElementById('announcement-cards-section');

    if (toggleCardsBtn && mainCardsGrid && achievementsCard) {
        let cardsVisible = localStorage.getItem('cardsVisible');
        if (cardsVisible === null) cardsVisible = 'true';

        function setCardsVisibility(visible) {
            const displayStyle = visible ? 'grid' : 'none';
            const displayBlock = visible ? 'block' : 'none';
            const iconClassAdd = visible ? 'fa-eye-slash' : 'fa-eye';
            const iconClassRemove = visible ? 'fa-eye' : 'fa-eye-slash';
            const buttonText = visible ? 'Ocultar Cards' : 'Mostrar Cards';

            mainCardsGrid.style.display = displayStyle;
            achievementsCard.style.display = displayBlock;
            if (announcementSection) announcementSection.style.display = displayBlock;
            
            toggleCardsBtn.innerHTML = `<i class="fas ${iconClassAdd} mr-2"></i> ${buttonText}`;
            localStorage.setItem('cardsVisible', visible.toString());
        }

        setCardsVisibility(cardsVisible === 'true');

        toggleCardsBtn.addEventListener('click', function() {
            cardsVisible = localStorage.getItem('cardsVisible');
            setCardsVisibility(cardsVisible !== 'true');
        });
    }

    // Avisos - Marcar como visto
    document.querySelectorAll(".mark-seen-checkbox").forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const announcementItem = this.closest(".non-fixed-announcement-item");
            const announcementId = announcementItem.dataset.announcementId;

            if (this.checked) {
                fetch('/student/mark_announcement_seen/' + announcementId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        announcementItem.classList.add('fade-out');
                        Toastify({ text: 'Aviso marcado como visto.', duration: 1500, backgroundColor: '#4CAF50' }).showToast();
                        // Remover o item do DOM após a animação
                        announcementItem.addEventListener('animationend', function() {
                            announcementItem.remove();
                            // Verificar se ainda há avisos não fixos
                            const container = document.getElementById('non-fixed-announcements-container');
                            if (container && container.querySelectorAll(".non-fixed-announcement-item").length === 0) {
                                container.remove();
                            }
                        });
                    } else {
                        this.checked = false; // Reverter o checkbox
                        Toastify({ text: data.message || 'Erro ao marcar aviso.', duration: 3000, backgroundColor: '#F44336' }).showToast();
                    }
                })
                .catch(error => {
                    this.checked = false;
                    console.error('Erro ao marcar aviso:', error);
                    Toastify({ text: 'Erro de comunicação.', duration: 3000, backgroundColor: '#F44336' }).showToast();
                });
            }
        });
    });

    // --- NOVA FUNCIONALIDADE: Alternância entre tipos de refinamento ---
    refineTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'status') {
                statusFilterWrapper.style.display = 'block';
                topicFilterWrapper.style.display = 'none';
                filterControls.topicFilter.disabled = true;
                filterControls.statusFilter.disabled = false;
            } else {
                statusFilterWrapper.style.display = 'none';
                topicFilterWrapper.style.display = 'block';
                filterControls.statusFilter.disabled = true;
                filterControls.topicFilter.disabled = false;
            }
            applyFilters(); // Aplicar filtros ao mudar o tipo de refinamento
        });
    });

    // --- ANIMAÇÕES E EFEITOS VISUAIS ---
    // Adicionar classe de loading durante filtros
    function showLoadingState(element) {
        if(element) element.classList.add('loading-state');
    }

    function hideLoadingState(element) {
        if(element) element.classList.remove('loading-state');
    }

    // Animação suave para mostrar/ocultar seções
    function fadeIn(element) {
        if (!element) return;
        element.style.display = 'block';
        element.style.opacity = '0';
        setTimeout(() => {
            element.style.opacity = '1';
        }, 10);
    }

    function fadeOut(element) {
        if (!element) return;
        element.style.opacity = '0';
        setTimeout(() => {
            element.style.display = 'none';
        }, 300);
    }

    // --- MOTIVAÇÃO DIÁRIA ---
    const motivationTexts = [
        "O sucesso é a soma de pequenos esforços repetidos dia após dia.",
        "Cada página estudada é um passo mais próximo do seu objetivo.",
        "A persistência é o caminho do êxito.",
        "Hoje é uma nova oportunidade de aprender algo novo.",
        "O conhecimento é a única coisa que ninguém pode tirar de você.",
        "Grandes conquistas começam com pequenas decisões.",
        "Estude como se fosse viver para sempre.",
        "O futuro pertence àqueles que se preparam hoje.",
        "Cada dia de estudo é um investimento no seu futuro.",
        "A disciplina é a ponte entre objetivos e conquistas."
    ];

    function setDailyMotivation() {
        const motivationDateEl = document.getElementById('motivation-date');
        const motivationTextEl = document.getElementById('motivation-text');
        if (!motivationDateEl || !motivationTextEl) return;

        const today = new Date();
        const dateString = today.toLocaleDateString('pt-BR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
        const motivationIndex = dayOfYear % motivationTexts.length;
        
        motivationDateEl.textContent = dateString;
        motivationTextEl.textContent = motivationTexts[motivationIndex];
    }

    setDailyMotivation();

    // --- TODO LIST FUNCTIONALITY ---
    const todoList = document.getElementById('todo-list');
    const newTodoItemInput = document.getElementById('new-todo-item');
    const addTodoBtn = document.getElementById('add-todo-btn');
    const noTodoItemsMessage = document.getElementById('no-todo-items-message');

    function renderTodoItem(item) {
        const li = document.createElement('li');
        li.className = `todo-item ${item.is_completed ? 'completed' : ''}`;
        li.dataset.itemId = item.id;
        li.innerHTML = `
            <label class="todo-item-content">
                <input type="checkbox" class="todo-checkbox" ${item.is_completed ? 'checked' : ''}>
                <span class="todo-item-text">${item.content.length > 40 ? item.content.substring(0, 40) + '...' : item.content}</span>
                <span class="todo-item-text-tooltip">${item.content}</span>
            </label>
            <div class="todo-actions">
                <button type="button" class="todo-delete-btn" title="Excluir tarefa">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `;

        // Event listener para marcar como completo/incompleto
        li.querySelector(".todo-checkbox").addEventListener('change', function() {
            updateTodoItem(item.id, { is_completed: this.checked });
            li.classList.toggle('completed');
        });

        // Event listener para deletar
        li.querySelector(".todo-delete-btn").addEventListener('click', function() {
            deleteTodoItem(item.id, li);
        });
        return li;
    }

    async function fetchTodoItems() {
        try {
            const response = await fetch('/student/get_todo_items');
            const data = await response.json();
            todoList.innerHTML = '';
            if (data.items.length > 0) {
                data.items.forEach(item => todoList.appendChild(renderTodoItem(item)));
                if(noTodoItemsMessage) noTodoItemsMessage.style.display = 'none';
            } else {
                if(noTodoItemsMessage) noTodoItemsMessage.style.display = 'block';
            }
        } catch (error) {
            console.error('Erro ao buscar tarefas:', error);
        }
    }

    async function addTodoItem(content) {
        try {
            const response = await fetch('/student/add_todo_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ content: content })
            });
            const data = await response.json();
            if (data.success) {
                todoList.appendChild(renderTodoItem(data.item));
                newTodoItemInput.value = '';
                if(noTodoItemsMessage) noTodoItemsMessage.style.display = 'none';
                Toastify({ text: 'Tarefa adicionada!', duration: 2000, backgroundColor: '#4CAF50' }).showToast();
            } else {
                Toastify({ text: data.message || 'Erro ao adicionar tarefa.', duration: 3000, backgroundColor: '#F44336' }).showToast();
            }
        } catch (error) {
            console.error('Erro ao adicionar tarefa:', error);
        }
    }

    async function updateTodoItem(itemId, updates) {
        try {
            const response = await fetch(`/student/update_todo_item/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(updates)
            });
            const data = await response.json();
            if (data.success) {
                Toastify({ text: 'Tarefa atualizada!', duration: 1500, backgroundColor: '#2196F3' }).showToast();
            } else {
                Toastify({ text: data.message || 'Erro ao atualizar tarefa.', duration: 3000, backgroundColor: '#F44336' }).showToast();
                // Reverter a mudança na UI se necessário
                fetchTodoItems(); 
            }
        } catch (error) {
            console.error('Erro ao atualizar tarefa:', error);
            fetchTodoItems();
        }
    }

    async function deleteTodoItem(itemId, listItemElement) {
        if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
        try {
            const response = await fetch(`/student/delete_todo_item/${itemId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });
            const data = await response.json();
            if (data.success) {
                listItemElement.remove();
                if (todoList.children.length === 0 && noTodoItemsMessage) {
                    noTodoItemsMessage.style.display = 'block';
                }
                Toastify({ text: 'Tarefa excluída!', duration: 2000, backgroundColor: '#FF9800' }).showToast();
            } else {
                Toastify({ text: data.message || 'Erro ao excluir tarefa.', duration: 3000, backgroundColor: '#F44336' }).showToast();
            }
        } catch (error) {
            console.error('Erro ao excluir tarefa:', error);
        }
    }

    if (addTodoBtn) {
        addTodoBtn.addEventListener('click', function() {
            const content = newTodoItemInput.value.trim();
            if (content) {
                addTodoItem(content);
            } else {
                Toastify({ text: 'Por favor, digite o conteúdo da tarefa.', duration: 2000, backgroundColor: '#FFC107' }).showToast();
            }
        });
    }
    if (newTodoItemInput) {
        newTodoItemInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                addTodoBtn.click();
            }
        });
    }

    // Carregar tarefas iniciais
    if (todoList) {
        fetchTodoItems();
    }

    // Inicializar filtros se houver parâmetros na URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('subject_id')) {
        filterControls.subject.value = urlParams.get('subject_id');
        // Disparar evento change para carregar diplomas e aplicar filtros
        const event = new Event('change');
        filterControls.subject.dispatchEvent(event);
    }

    console.log('Dashboard melhorado e completo carregado com sucesso!');
});
</script>
{% endblock %}

