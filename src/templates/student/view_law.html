{% extends "base.html" %}

{% block title %}{{ law.title }} - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    /* Toggle de modo escuro */
    .dark-mode-toggle {
        position: fixed;
        top: 5rem;
        right: 1.5rem;
        z-index: 50;
        background-color: #ffffff;
        color: #2563eb;
        border: 1px solid #bfdbfe;
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .dark-mode-toggle:hover {
        transform: scale(1.05);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .dark-mode .dark-mode-toggle {
        background-color: #1f2937;
        color: #fbbf24;
        border-color: #374151;
    }

    @media (max-width: 768px) {
        .dark-mode-toggle {
            top: 4.5rem;
            right: 1rem;
            width: 2rem;
            height: 2rem;
        }
    }

    .law-content-container {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        color: #1f2937; /* Dark gray text for readability */
        line-height: 1.7;
        /* Proteção contra seleção de texto para cópia - Mantida conforme original */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        /* Adicionando borda azul clara */
        border: 1px solid #bfdbfe; /* Tailwind blue-200 */
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    /* Modo escuro para o conteúdo da lei */
    .dark-mode .law-content-container {
        background-color: #1f2937; /* Gray 800 */
        color: #e5e7eb; /* Gray 200 */
        border-color: #374151; /* Gray 700 */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }

    .law-content-container h1, .law-content-container h2, .law-content-container h3 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
        transition: color 0.3s ease;
    }

    .dark-mode .law-content-container h1, 
    .dark-mode .law-content-container h2, 
    .dark-mode .law-content-container h3 {
        color: #f3f4f6; /* Gray 100 */
    }

    .law-content-container p {
        margin-bottom: 1em;
    }
    .law-content-container ul, .law-content-container ol {
        margin-left: 1.5em;
        margin-bottom: 1em;
    }
    .law-content-container li {
        margin-bottom: 0.5em;
    }
    .law-content-container strong { font-weight: bold; }
    .law-content-container em { font-style: italic; }
    .law-content-container u { text-decoration: underline; }
    .law-content-container s { text-decoration: line-through; }
    
    /* Cores de fundo para o modo escuro */
    .dark-mode .ql-bg-yellow { background-color: #854d0e; /* Yellow 800 */ }
    .dark-mode .ql-bg-red { background-color: #7f1d1d; /* Red 900 */ }
    
    .completed-banner {
        background-color: #d1fae5; /* Light green */
        color: #065f46; /* Dark green */
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        border: 1px solid #a7f3d0;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    /* Modo escuro para o banner de conclusão */
    .dark-mode .completed-banner {
        background-color: #065f46; /* Green 800 */
        color: #d1fae5; /* Green 100 */
        border-color: #047857; /* Green 700 */
    }

    .last-read-info {
        background-color: #e0e7ff; /* Indigo 100 */
        color: #3730a3; /* Indigo 800 */
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        border: 1px solid #c7d2fe; /* Indigo 200 */
        font-size: 0.9rem;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    /* Modo escuro para a informação de última leitura */
    .dark-mode .last-read-info {
        background-color: #312e81; /* Indigo 900 */
        color: #e0e7ff; /* Indigo 100 */
        border-color: #4f46e5; /* Indigo 600 */
    }

    .save-article-form {
        margin-top: 1.5rem;
        padding: 1rem;
        background-color: #f9fafb; /* Gray 50 */
        border: 1px solid #e5e7eb; /* Gray 200 */
        border-radius: 0.5rem;
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    /* Modo escuro para o formulário de salvar artigo */
    .dark-mode .save-article-form {
        background-color: #111827; /* Gray 900 */
        border-color: #374151; /* Gray 700 */
    }

    /* Estilos para os botões de toggle */
    .toggle-button {
        background-color: #e5e7eb; /* gray-200 */
        color: #374151; /* gray-700 */
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, color 0.3s ease;
        border: 1px solid #d1d5db; /* gray-300 */
    }

    /* Modo escuro para os botões de toggle */
    .dark-mode .toggle-button {
        background-color: #374151; /* Gray 700 */
        color: #e5e7eb; /* Gray 200 */
        border-color: #4b5563; /* Gray 600 */
    }

    .toggle-button:hover {
        background-color: #d1d5db; /* gray-300 */
    }

    .dark-mode .toggle-button:hover {
        background-color: #4b5563; /* Gray 600 */
    }

    .toggle-button.active {
        /* Estilo quando o conteúdo está OCULTO (botão para MOSTRAR) */
        background-color: #3b82f6; /* blue-500 */
        color: white;
        border-color: #2563eb; /* blue-600 */
    }
    .toggle-button.active:hover {
        background-color: #2563eb; /* blue-600 */
    }

    .dark-mode .toggle-button.active {
        background-color: #2563eb; /* Blue 600 */
        border-color: #1d4ed8; /* Blue 700 */
    }

    .dark-mode .toggle-button.active:hover {
        background-color: #1d4ed8; /* Blue 700 */
    }

    /* Classe CSS para ocultar elementos */
    .conteudo-oculto {
        display: none !important; /* Usar !important para garantir a sobreposição */
    }
    /* Estilos para o container do player de áudio */
    .audio-player-container {
        background-color: #f9fafb; /* Tailwind gray-50 - um pouco mais claro */
        border-radius: 0.5rem; /* Tailwind rounded-lg */
        padding: 1rem; /* Tailwind p-4 */
        border: 1px solid #e5e7eb; /* Tailwind gray-200 */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Tailwind shadow-sm mais suave */
        margin-bottom: 1.5rem; /* Equivalente a my-4 ou mb-6 */
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    /* Modo escuro para o player de áudio */
    .dark-mode .audio-player-container {
        background-color: #111827; /* Gray 900 */
        border-color: #374151; /* Gray 700 */
    }

    .audio-player-container audio {
        border-radius: 0.375rem; /* Tailwind rounded-md */
        /* Estilos adicionais para o player podem não ser consistentes entre navegadores */
        /* Exemplo: filter: sepia(20%) invert(90%); */
    }

    /* Estilos para o modo escuro em elementos específicos */
    .dark-mode .text-blue-700 {
        color: #60a5fa !important; /* Blue 400 */
    }

    .dark-mode .text-purple-600 {
        color: #a78bfa !important; /* Purple 400 */
    }

    .dark-mode .hover\:text-purple-800:hover {
        color: #c4b5fd !important; /* Purple 300 */
    }

    .dark-mode .text-sm.font-medium.text-gray-700 {
        color: #e5e7eb !important; /* Gray 200 */
    }

    .dark-mode .shadow-sm.appearance-none.border.border-gray-300 {
        border-color: #4b5563 !important; /* Gray 600 */
        background-color: #1f2937 !important; /* Gray 800 */
        color: #e5e7eb !important; /* Gray 200 */
    }

    .dark-mode .focus\:ring-2.focus\:ring-purple-500 {
        --tw-ring-color: #8b5cf6 !important; /* Purple 500 */
    }

    .dark-mode .bg-indigo-500 {
        background-color: #6366f1 !important; /* Indigo 500 */
    }

    .dark-mode .hover\:bg-indigo-600:hover {
        background-color: #4f46e5 !important; /* Indigo 600 */
    }

    .dark-mode .bg-green-500 {
        background-color: #10b981 !important; /* Green 500 */
    }

    .dark-mode .hover\:bg-green-600:hover {
        background-color: #059669 !important; /* Green 600 */
    }
</style>
{% endblock %}

{% block content %}
<!-- Botão de alternar modo escuro -->
<button id="darkModeToggle" class="dark-mode-toggle" aria-label="Alternar modo escuro">
    <i class="fas fa-moon"></i>
</button>

<div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
    <h1 class="text-xl md:text-2xl font-bold text-blue-700">{{ law.title }}</h1>
    {# CORRIGIDO: Removido \ das aspas #}
    <a href="{{ url_for('student.dashboard') }}" class="text-sm md:text-base text-purple-600 hover:text-purple-800 whitespace-nowrap self-end sm:self-center">
        <i class="fas fa-arrow-left mr-1 md:mr-2"></i> Voltar ao Painel
    </a>
</div>

<!-- ****** Player de Áudio (se disponível) ****** -->
{% if law.audio_url %}
<div class="audio-player-container"> {# Removidas classes Tailwind diretas, usando a classe CSS acima #}
    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
        <i class="fas fa-headphones-alt mr-2"></i> Ouvir a Lei:
    </h4>
    <audio controls class="w-full">
        <source src="{{ law.audio_url }}" type="audio/mpeg"> {# Ajuste o type se necessário (ex: audio/ogg, audio/wav) #}
        Seu navegador não suporta o elemento de áudio.
    </audio>
    {# Texto removido daqui #}
</div>
{% endif %}
<!-- ****** FIM Player de Áudio ****** -->

{% if is_completed %}
<div class="completed-banner" role="alert">
    <i class="fas fa-check-circle mr-2"></i> Você já concluiu esta legislação!
</div>
{% elif last_read_article %}
<div class="last-read-info" role="alert">
    <i class="fas fa-bookmark mr-2"></i> Você parou no artigo: <strong>{{ last_read_article }}</strong>
</div>
{% endif %}

<!-- Botões de Toggle -->
<div class="flex space-x-2 mb-4">
    <button id="toggle-comments-btn" class="toggle-button">
        <i class="fas fa-eye-slash mr-1"></i> Ocultar Comentários
    </button>
    <button id="toggle-jurisprudence-btn" class="toggle-button">
        <i class="fas fa-eye-slash mr-1"></i> Ocultar Jurisprudências
    </button>
    <button id="toggle-doutrina-btn" class="toggle-button">
        <i class="fas fa-eye-slash mr-1"></i> Ocultar Doutrina
    </button>
</div>
<!-- Fim dos Botões de Toggle -->

<div class="law-content-container" id="law-content">
    {% if law.description %}
        <p class="text-gray-600 italic mb-6">{{ law.description }}</p>
    {% endif %}
    
    {{ law.content | safe }}
</div>

{% if not is_completed %}
<!-- Save Last Read Article Form -->
<div class="save-article-form">
    {# CORRIGIDO: Removido \ das aspas #}
    <form action="{{ url_for('student.save_last_read', law_id=law.id) }}" method="POST" class="flex items-center space-x-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> {# <-- Campo CSRF oculto #}
        <label for="last_article" class="text-sm font-medium text-gray-700">Parou no artigo nº:</label>
        <input type="text" id="last_article" name="last_article" 
               placeholder="Ex: 15" value="{{ last_read_article or '' }}"
               class="shadow-sm appearance-none border border-gray-300 rounded-md py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent w-24">
        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-1 px-3 rounded-md transition duration-300 text-sm">
            <i class="fas fa-save mr-1"></i> Salvar Posição
        </button>
    </form>
</div>

<!-- Mark as Complete Button -->
<div class="mt-8 text-center">
    {# CORRIGIDO: Removido \ das aspas #}
    <form action="{{ url_for('student.mark_complete', law_id=law.id) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> {# <-- Campo CSRF oculto #}
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 text-lg shadow-md">
            <i class="fas fa-check mr-2"></i> Marcar como Concluído
        </button>
    </form>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// --- NOVO: Manipulador para o modo escuro ---
document.addEventListener('DOMContentLoaded', function() {
    const darkModeToggle = document.getElementById('darkModeToggle');
    const htmlElement = document.documentElement;
    
    // Verificar se o modo escuro está salvo no localStorage
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    
    // Aplicar modo escuro se estiver salvo
    if (isDarkMode) {
        htmlElement.classList.add('dark-mode');
        darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    // Alternar modo escuro ao clicar no botão
    darkModeToggle.addEventListener('click', function() {
        htmlElement.classList.toggle('dark-mode');
        
        // Atualizar ícone
        if (htmlElement.classList.contains('dark-mode')) {
            this.innerHTML = '<i class="fas fa-sun"></i>';
            localStorage.setItem('darkMode', 'true');
        } else {
            this.innerHTML = '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', 'false');
        }
    });
});
// --- FIM NOVO ---

// --- Script para Ocultar/Mostrar Comentários, Jurisprudências e Doutrina (v4 - Adicionado suporte para Doutrina) ---
document.addEventListener("DOMContentLoaded", function () {
    const lawContent = document.getElementById("law-content");
    const toggleCommentsBtn = document.getElementById("toggle-comments-btn");
    const toggleJurisprudenceBtn = document.getElementById("toggle-jurisprudence-btn");
    const toggleDoutrinaBtn = document.getElementById("toggle-doutrina-btn");

    // Seletores baseados nos estilos inline identificados
    const commentSelector = 'p[style*="background-color: #f0fdf4"]';
    const jurisprudenceSelector = 'p[style*="background-color: #fef2f2"]';
    const doutrinaSelector = 'p[style*="background-color: #f5f3ff"]';
    const hiddenClass = "conteudo-oculto"; // Nome da classe CSS para ocultar

    // Estado inicial: conteúdo visível
    let commentsVisible = true;
    let jurisprudenceVisible = true;
    let doutrinaVisible = true;

    function toggleElementsVisibility(selector, makeVisible) {
        const elements = lawContent.querySelectorAll(selector);
        elements.forEach((el) => {
            if (makeVisible) {
                el.classList.remove(hiddenClass);
            } else {
                el.classList.add(hiddenClass);
            }
        });
    }

    // Event listener para o botão de comentários
    toggleCommentsBtn.addEventListener("click", function () {
        commentsVisible = !commentsVisible; // Inverte o estado
        toggleElementsVisibility(commentSelector, commentsVisible); // Aplica o novo estado aos elementos

        // Atualiza a aparência do botão
        if (commentsVisible) {
            this.classList.remove("active");
            this.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Ocultar Comentários';
        } else {
            this.classList.add("active");
            this.innerHTML = '<i class="fas fa-eye mr-1"></i> Mostrar Comentários';
        }
    });

    // Event listener para o botão de jurisprudências
    toggleJurisprudenceBtn.addEventListener("click", function () {
        jurisprudenceVisible = !jurisprudenceVisible; // Inverte o estado
        toggleElementsVisibility(jurisprudenceSelector, jurisprudenceVisible); // Aplica o novo estado aos elementos

        // Atualiza a aparência do botão
        if (jurisprudenceVisible) {
            this.classList.remove("active");
            this.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Ocultar Jurisprudências';
        } else {
            this.classList.add("active");
            this.innerHTML = '<i class="fas fa-eye mr-1"></i> Mostrar Jurisprudências';
        }
    });

    // Event listener para o botão de doutrina
    toggleDoutrinaBtn.addEventListener("click", function () {
        doutrinaVisible = !doutrinaVisible; // Inverte o estado
        toggleElementsVisibility(doutrinaSelector, doutrinaVisible); // Aplica o novo estado aos elementos

        // Atualiza a aparência do botão
        if (doutrinaVisible) {
            this.classList.remove("active");
            this.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Ocultar Doutrina';
        } else {
            this.classList.add("active");
            this.innerHTML = '<i class="fas fa-eye mr-1"></i> Mostrar Doutrina';
        }
    });

    // Garantir que o estado inicial (visível) não tenha a classe de ocultar
    // (Caso a página seja recarregada com elementos ocultos por algum motivo)
    toggleElementsVisibility(commentSelector, true);
    toggleElementsVisibility(jurisprudenceSelector, true);
    toggleElementsVisibility(doutrinaSelector, true);
});
// --- Fim do Script de Toggle ---


// 🛡️ PROTEÇÕES DISCRETAS - APENAS CÓPIA E IMPRESSÃO (Mantidas conforme original)

// ✅ Anti-impressão (Ctrl+P)
document.addEventListener("keydown", function (e) {
    if (e.ctrlKey && (e.key === "p" || e.key === "P")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Impressão não permitida neste conteúdo.");
        return false;
    }
});

// ✅ Anti-cópia (Ctrl+C, Ctrl+A, Ctrl+X)
document.addEventListener("keydown", function (e) {
    // Bloquear Ctrl+C (copiar)
    if (e.ctrlKey && (e.key === "c" || e.key === "C")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Cópia de conteúdo não permitida.");
        return false;
    }

    // Bloquear Ctrl+A (selecionar tudo)
    if (e.ctrlKey && (e.key === "a" || e.key === "A")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Seleção total não permitida.");
        return false;
    }

    // Bloquear Ctrl+X (recortar)
    if (e.ctrlKey && (e.key === "x" || e.key === "X")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Recorte não permitido.");
        return false;
    }
});

// ✅ Proteção contra seleção de texto
document.addEventListener("selectstart", function (e) {
    e.preventDefault();
    return false;
});

// ✅ Menu de contexto desabilitado (botão direito)
document.addEventListener("contextmenu", function (e) {
    e.preventDefault();
    alert("Menu de contexto desabilitado.");
    return false;
});
</script>
{% endblock %}
