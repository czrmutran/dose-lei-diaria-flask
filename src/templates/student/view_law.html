{% extends "base.html" %}

{% block title %}{{ law.title }} - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    /* --- NOVO: Estilos para o modo escuro --- */
    .dark-mode {
        background-color: #1e293b !important; /* Slate 800 - Azul escuro mais suave */
        color: #f1f5f9 !important; /* Slate 100 - Texto claro para o modo noturno */
    }

    /* Toggle de modo escuro */
    .dark-mode-toggle {
        position: fixed;
        top: 5rem;
        right: 1.5rem;
        z-index: 50;
        background-color: #ffffff;
        color: #2563eb;
        border: 1px solid #bfdbfe;
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .dark-mode-toggle:hover {
        transform: scale(1.05);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .dark-mode .dark-mode-toggle {
        background-color: #334155; /* Slate 700 */
        color: #fbbf24; /* Amber 400 */
        border-color: #475569; /* Slate 600 */
    }

    @media (max-width: 768px) {
        .dark-mode-toggle {
            top: 4.5rem;
            right: 1rem;
            width: 2rem;
            height: 2rem;
        }
    }
    /* --- FIM NOVO --- */

    /* --- NOVO: Estilo para fundo azul claro --- */
    .law-container {
        background-color: #f0f7ff; /* Fundo azul claro solicitado */
        min-height: 100vh; /* Garante que o fundo cubra toda a altura da tela */
        width: 100%;
        padding: 1rem;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Modo escuro para o container da lei */
    .dark-mode .law-container {
        background-color: #1e293b; /* Slate 800 - Azul escuro mais suave */
        color: #f1f5f9; /* Slate 100 - Texto claro para o modo noturno */
    }

    @media (max-width: 768px) {
        .law-container {
            padding: 0.5rem; /* Padding menor em telas pequenas */
        }
    }
    /* --- FIM NOVO --- */

    /* Estilos para o conteúdo da lei */
    .law-content {
        background-color: #FFFFFF;
        border: 1px solid #dbeafe;
        border-radius: 0.5rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    /* Modo escuro para o conteúdo da lei */
    .dark-mode .law-content {
        background-color: #334155; /* Slate 700 */
        border-color: #475569; /* Slate 600 */
        color: #f1f5f9; /* Slate 100 */
    }

    /* Estilos para os comentários */
    .comment-box {
        background-color: #f0f9ff; /* Azul muito claro */
        border: 1px solid #bae6fd; /* Azul claro */
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    /* Modo escuro para os comentários */
    .dark-mode .comment-box {
        background-color: #0f172a; /* Slate 900 */
        border-color: #1e40af; /* Blue 800 */
        color: #f1f5f9; /* Slate 100 */
    }

    /* Estilos para a jurisprudência */
    .jurisprudence-box {
        background-color: #fff1f2; /* Rosa muito claro */
        border: 1px solid #fecdd3; /* Rosa claro */
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    /* Modo escuro para a jurisprudência */
    .dark-mode .jurisprudence-box {
        background-color: #450a0a; /* Red 950 */
        border-color: #7f1d1d; /* Red 800 */
        color: #fecdd3; /* Red 200 */
    }

    /* Estilos para a doutrina */
    .doctrine-box {
        background-color: #ecfdf5; /* Verde muito claro */
        border: 1px solid #a7f3d0; /* Verde claro */
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    /* Modo escuro para a doutrina */
    .dark-mode .doctrine-box {
        background-color: #064e3b; /* Green 900 */
        border-color: #047857; /* Green 700 */
        color: #a7f3d0; /* Green 200 */
    }

    /* Botões de toggle para comentários, jurisprudência e doutrina */
    .toggle-button {
        background-color: #475569; /* Slate 600 */
        color: #f8fafc; /* Slate 50 */
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .toggle-button:hover {
        background-color: #334155; /* Slate 700 */
    }
    
    .toggle-button i {
        margin-right: 0.5rem;
    }
    
    /* Modo escuro para os botões de toggle */
    .dark-mode .toggle-button {
        background-color: #334155; /* Slate 700 */
        color: #f1f5f9; /* Slate 100 */
    }
    
    .dark-mode .toggle-button:hover {
        background-color: #1e293b; /* Slate 800 */
    }

    /* Estilos para o botão de voltar */
    .back-button {
        display: inline-flex;
        align-items: center;
        color: #3b82f6; /* Blue 500 */
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: color 0.2s ease;
        margin-bottom: 1rem;
    }
    
    .back-button:hover {
        color: #2563eb; /* Blue 600 */
        text-decoration: underline;
    }
    
    .back-button i {
        margin-right: 0.5rem;
    }
    
    /* Modo escuro para o botão de voltar */
    .dark-mode .back-button {
        color: #60a5fa; /* Blue 400 */
    }
    
    .dark-mode .back-button:hover {
        color: #93c5fd; /* Blue 300 */
    }

    /* Estilos para o indicador de progresso */
    .progress-indicator {
        background-color: #1e3a8a; /* Indigo 900 */
        color: #ffffff;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 1rem;
        display: inline-flex;
        align-items: center;
    }
    
    .progress-indicator i {
        margin-right: 0.5rem;
    }
    
    /* Modo escuro para o indicador de progresso */
    .dark-mode .progress-indicator {
        background-color: #312e81; /* Indigo 900 */
        color: #e0e7ff; /* Indigo 100 */
    }

    /* Estilos para títulos e subtítulos */
    .law-title {
        color: #1e40af; /* Blue 800 */
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        transition: color 0.3s ease;
    }
    
    /* Modo escuro para títulos */
    .dark-mode .law-title {
        color: #60a5fa; /* Blue 400 */
    }

    .law-subtitle {
        color: #2563eb; /* Blue 600 */
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        transition: color 0.3s ease;
    }
    
    /* Modo escuro para subtítulos */
    .dark-mode .law-subtitle {
        color: #93c5fd; /* Blue 300 */
    }

    /* Estilos para o texto da lei */
    .law-text {
        line-height: 1.7;
        margin-bottom: 1.5rem;
        transition: color 0.3s ease;
    }
    
    /* Modo escuro para o texto da lei */
    .dark-mode .law-text {
        color: #f1f5f9; /* Slate 100 */
    }

    /* Estilos para o botão de favorito */
    .favorite-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: #d1d5db; /* Cinza claro por padrão (não favorito) */
        font-size: 1.25rem; /* Tamanho do ícone */
        transition: color 0.2s ease, transform 0.2s ease;
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
    }
    
    .favorite-btn:hover {
        transform: scale(1.1);
    }
    
    .favorite-btn.favorited {
        color: #facc15; /* Amarelo/Dourado para favorito */
    }
    
    /* Modo escuro para o botão de favorito */
    .dark-mode .favorite-btn {
        color: #6b7280; /* Gray 500 */
    }
    
    .dark-mode .favorite-btn.favorited {
        color: #fbbf24; /* Amber 400 */
    }
</style>
{% endblock %}

{% block content %}
<!-- Botão de alternar modo escuro -->
<button id="darkModeToggle" class="dark-mode-toggle" aria-label="Alternar modo escuro">
    <i class="fas fa-moon"></i>
</button>

<!-- NOVO: Wrapper com fundo azul claro -->
<div class="law-container">
    <!-- Botão de voltar -->
    <a href="{{ url_for('student.dashboard') }}" class="back-button">
        <i class="fas fa-arrow-left"></i> Voltar ao Painel
    </a>

    <!-- Título da Lei -->
    <h1 class="law-title">{{ law.title }}</h1>

    <!-- Indicador de progresso -->
    <div class="progress-indicator">
        <i class="fas fa-bookmark"></i> Você parou no artigo: {{ current_article }}
    </div>

    <!-- Botões de toggle -->
    <div class="mb-4">
        <button id="toggleComments" class="toggle-button">
            <i class="fas fa-comment"></i> Ocultar Comentários
        </button>
        <button id="toggleJurisprudence" class="toggle-button">
            <i class="fas fa-gavel"></i> Ocultar Jurisprudências
        </button>
        <button id="toggleDoctrine" class="toggle-button">
            <i class="fas fa-book"></i> Ocultar Doutrina
        </button>
    </div>

    <!-- Conteúdo da Lei -->
    <div class="law-content">
        <!-- Botão de favorito -->
        <button type="button" id="favoriteBtn" class="favorite-btn {% if is_favorite %}favorited{% endif %}" 
                title="{% if is_favorite %}Remover dos Favoritos{% else %}Adicionar aos Favoritos{% endif %}">
            <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-star"></i>
        </button>

        <!-- Texto da Lei -->
        <div class="law-text">
            {{ law_content|safe }}
        </div>

        <!-- Comentários -->
        <div id="commentsSection" class="comment-box">
            <h2 class="law-subtitle">Comentários</h2>
            {% if comments %}
                {% for comment in comments %}
                    <div class="mb-4">
                        <p class="font-semibold">{{ comment.title }}</p>
                        <p>{{ comment.content }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>Não há comentários disponíveis para esta lei.</p>
            {% endif %}
        </div>

        <!-- Jurisprudência -->
        <div id="jurisprudenceSection" class="jurisprudence-box">
            <h2 class="law-subtitle">Jurisprudência</h2>
            {% if jurisprudence %}
                {% for item in jurisprudence %}
                    <div class="mb-4">
                        <p class="font-semibold">{{ item.title }}</p>
                        <p>{{ item.content }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>Não há jurisprudência disponível para esta lei.</p>
            {% endif %}
        </div>

        <!-- Doutrina -->
        <div id="doctrineSection" class="doctrine-box">
            <h2 class="law-subtitle">Doutrina</h2>
            {% if doctrine %}
                {% for item in doctrine %}
                    <div class="mb-4">
                        <p class="font-semibold">{{ item.title }}</p>
                        <p>{{ item.content }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p>Não há doutrina disponível para esta lei.</p>
            {% endif %}
        </div>
    </div>
</div>
<!-- FIM: Wrapper com fundo azul claro -->

<!-- Hidden CSRF Token Field for AJAX Requests -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obter o token CSRF do campo oculto
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    // --- NOVO: Manipulador para o modo escuro ---
    const darkModeToggle = document.getElementById('darkModeToggle');
    const htmlElement = document.documentElement;
    
    // Verificar se o modo escuro está salvo no localStorage
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    
    // Aplicar modo escuro se estiver salvo
    if (isDarkMode) {
        htmlElement.classList.add('dark-mode');
        darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    // Alternar modo escuro ao clicar no botão
    darkModeToggle.addEventListener('click', function() {
        htmlElement.classList.toggle('dark-mode');
        
        // Atualizar ícone
        if (htmlElement.classList.contains('dark-mode')) {
            this.innerHTML = '<i class="fas fa-sun"></i>';
            localStorage.setItem('darkMode', 'true');
        } else {
            this.innerHTML = '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', 'false');
        }
    });
    // --- FIM NOVO ---
    
    // Toggle para comentários
    const toggleCommentsBtn = document.getElementById('toggleComments');
    const commentsSection = document.getElementById('commentsSection');
    
    toggleCommentsBtn.addEventListener('click', function() {
        commentsSection.classList.toggle('hidden');
        if (commentsSection.classList.contains('hidden')) {
            toggleCommentsBtn.innerHTML = '<i class="fas fa-comment"></i> Mostrar Comentários';
        } else {
            toggleCommentsBtn.innerHTML = '<i class="fas fa-comment"></i> Ocultar Comentários';
        }
    });
    
    // Toggle para jurisprudência
    const toggleJurisprudenceBtn = document.getElementById('toggleJurisprudence');
    const jurisprudenceSection = document.getElementById('jurisprudenceSection');
    
    toggleJurisprudenceBtn.addEventListener('click', function() {
        jurisprudenceSection.classList.toggle('hidden');
        if (jurisprudenceSection.classList.contains('hidden')) {
            toggleJurisprudenceBtn.innerHTML = '<i class="fas fa-gavel"></i> Mostrar Jurisprudências';
        } else {
            toggleJurisprudenceBtn.innerHTML = '<i class="fas fa-gavel"></i> Ocultar Jurisprudências';
        }
    });
    
    // Toggle para doutrina
    const toggleDoctrineBtn = document.getElementById('toggleDoctrine');
    const doctrineSection = document.getElementById('doctrineSection');
    
    toggleDoctrineBtn.addEventListener('click', function() {
        doctrineSection.classList.toggle('hidden');
        if (doctrineSection.classList.contains('hidden')) {
            toggleDoctrineBtn.innerHTML = '<i class="fas fa-book"></i> Mostrar Doutrina';
        } else {
            toggleDoctrineBtn.innerHTML = '<i class="fas fa-book"></i> Ocultar Doutrina';
        }
    });
    
    // Manipulador para o botão de favorito
    const favoriteBtn = document.getElementById('favoriteBtn');
    
    favoriteBtn.addEventListener('click', function() {
        const lawId = {{ law.id }};
        const apiUrl = `/student/law/toggle_favorite/${lawId}`;
        
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Erro na resposta da API');
        })
        .then(data => {
            if (data.success) {
                // Alternar classe e ícone
                if (data.favorited) {
                    this.classList.add('favorited');
                    this.querySelector('i').className = 'fas fa-star'; // Ícone preenchido
                    this.title = 'Remover dos Favoritos';
                } else {
                    this.classList.remove('favorited');
                    this.querySelector('i').className = 'far fa-star'; // Ícone de contorno
                    this.title = 'Adicionar aos Favoritos';
                }
                
                // Efeito visual de feedback
                this.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Não foi possível atualizar os favoritos. Por favor, tente novamente.');
        });
    });
});
</script>
{% endblock %}
