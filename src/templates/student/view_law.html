{% extends "base.html" %}

{% block title %}{{ law.title }} - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    /* --- Estilos Anteriores (Intactos) --- */
    .progress-bar-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background-color: transparent;
        z-index: 9999;
    }
    .progress-bar {
        height: 100%;
        background-color: #2563eb;
        width: 0%;
        transition: width 0.1s linear;
    }
    .highlight-article {
        animation: highlight-fade 2s ease-out;
    }
    @keyframes highlight-fade {
        0% { background-color: #fef9c3; }
        70% { background-color: #fef9c3; }
        100% { background-color: transparent; }
    }
    .law-content-container {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        color: #1f2937;
        line-height: 1.7;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        border: 1px solid #bfdbfe;
    }
    .law-content-container h1, .law-content-container h2, .law-content-container h3 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
    }
    .law-content-container p { margin-bottom: 1em; }
    .law-content-container ul, .law-content-container ol { margin-left: 1.5em; margin-bottom: 1em; }
    .law-content-container li { margin-bottom: 0.5em; }
    .law-content-container strong { font-weight: bold; }
    .law-content-container em { font-style: italic; }
    .law-content-container u { text-decoration: underline; }
    .law-content-container s { text-decoration: line-through; }
    .completed-banner { background-color: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1.5rem; border: 1px solid #a7f3d0; }
    .last-read-info { background-color: #e0e7ff; color: #3730a3; padding: 0.75rem 1rem; border-radius: 0.375rem; margin-bottom: 1.5rem; border: 1px solid #c7d2fe; font-size: 0.9rem; }
    .toggle-button { background-color: #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; border: 1px solid #d1d5db; }
    .toggle-button:hover { background-color: #d1d5db; }
    .toggle-button.active { background-color: #3b82f6; color: white; border-color: #2563eb; }
    .toggle-button.active:hover { background-color: #2563eb; }
    .conteudo-oculto { display: none !important; }
    /* ... (outros estilos originais inalterados) ... */

    /* ===================================================================== */
    /* <<< INÍCIO: NOVOS ESTILOS PARA O SISTEMA DE COMENTÁRIOS >>> */
    /* ===================================================================== */
    .paragraph-wrapper {
        position: relative;
        padding-right: 30px;
    }
    .comment-icon {
        position: absolute;
        top: 5px;
        right: 0;
        cursor: pointer;
        color: #a5b4fc;
        font-size: 1.1rem;
        transition: all 0.2s ease;
        opacity: 0.5;
    }
    .paragraph-wrapper:hover .comment-icon {
        opacity: 1;
        transform: scale(1.2);
    }
    .comment-icon.has-comment {
        color: #6366f1;
        opacity: 1;
    }
    .comment-display {
        background-color: #eef2ff;
        border-left: 3px solid #6366f1;
        padding: 10px 15px;
        margin-top: 5px;
        margin-bottom: 15px;
        border-radius: 0 5px 5px 0;
        font-size: 0.9em;
        position: relative;
        transition: all 0.3s ease-out;
    }
    .comment-delete-btn {
        position: absolute;
        top: 5px;
        right: 8px;
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 0.9rem;
    }
    .comment-delete-btn:hover { color: #ef4444; }

    /* Regras para ocultar o CONTEÚDO dos comentários */
    #law-content.user-comment-content-hidden .comment-display p {
        display: none;
    }
    #law-content.user-comment-content-hidden .comment-display::after {
        content: 'Comentário oculto...';
        font-style: italic;
        color: #6b7280;
    }

    /* Modal de Comentário */
    .comment-modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .comment-modal-content { background-color: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .comment-modal-textarea { width: 100%; min-height: 120px; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; margin-bottom: 15px; }
</style>
{% endblock %}

{% block content %}
<div class="progress-bar-container">
    <div class="progress-bar" id="reading-progress-bar"></div>
</div>
<div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0" id="page-top">
    <h1 class="text-xl md:text-2xl font-bold text-blue-700">{{ law.title }}</h1>
    <div class="flex justify-end w-full sm:w-auto">
        <a href="{{ url_for('student.dashboard') }}" class="flex items-center bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200 text-sm">
            <i class="fas fa-arrow-left mr-2"></i>Voltar ao Painel
        </a>
    </div>
</div>

<div class="neural-waves-container">
    <button class="neural-wave-button wave-alpha" data-wave="alpha" aria-label="Onda Alfa"><i class="fas fa-brain"></i><span class="tooltip">Onda Alfa (8-12Hz) <br>Ideal para relaxamento alerta e foco sem tensão</span></button>
    <button class="neural-wave-button wave-beta" data-wave="beta" aria-label="Onda Beta"><i class="fas fa-bolt"></i><span class="tooltip">Onda Beta (12-30Hz) <br>Perfeita para análise jurídica e raciocínio lógico</span></button>
    <button class="neural-wave-button wave-theta" data-wave="theta" aria-label="Onda Teta"><i class="fas fa-moon"></i><span class="tooltip">Onda Teta (4-8Hz) <br>Auxilia na compreensão de conceitos jurídicos complexos</span></button>
    <button class="neural-wave-button wave-classical" data-wave="classical" aria-label="Música Clássica"><i class="fas fa-music"></i><span class="tooltip">Música Clássica <br>Promove concentração elevada e processamento cognitivo aprimorado</span></button>
    <button class="neural-wave-button wave-white-noise" data-wave="white-noise" aria-label="Ruído Branco"><i class="fas fa-volume-up"></i><span class="tooltip">Ruído Branco <br>Bloqueia distrações externas e mantém o foco sustentado</span></button>
</div>
<audio id="audio-alpha" src="https://audios-estudoleieca.s3.us-west-2.amazonaws.com/alpha_wave.mp3" preload="none" loop style="display: none;"></audio>
<audio id="audio-beta" src="https://audios-estudoleieca.s3.us-west-2.amazonaws.com/beta_wave.mp3" preload="none" loop style="display: none;"></audio>
<audio id="audio-theta" src="https://audios-estudoleieca.s3.us-west-2.amazonaws.com/theta_wave.mp3" preload="none" loop style="display: none;"></audio>
<audio id="audio-classical" src="https://audios-estudoleieca.s3.us-west-2.amazonaws.com/classical_music.mp3" preload="none" loop style="display: none;"></audio>
<audio id="audio-white-noise" src="https://audios-estudoleieca.s3.us-west-2.amazonaws.com/white_noise.mp3" preload="none" loop style="display: none;"></audio>

{% if law.audio_url %}
<div class="audio-player-container">
    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center"><i class="fas fa-headphones-alt mr-2"></i> Ouvir a Lei:</h4>
    <audio controls controlslist="nodownload" class="w-full">
        <source src="{{ law.audio_url }}" type="audio/mpeg">
        Seu navegador não suporta o elemento de áudio.
    </audio>
</div>
{% endif %}

{% if is_completed %}
<div class="completed-banner" role="alert">
    <i class="fas fa-check-circle mr-2"></i> Você já concluiu esta legislação!
</div>
{% elif last_read_article %}
<div class="last-read-info" role="alert">
    <i class="fas fa-bookmark mr-2"></i> Você parou no artigo: <strong>{{ last_read_article }}</strong>
</div>
{% endif %}

<div id="sticky-action-bar" class="sticky top-1 z-20 bg-gray-50 py-3 px-4 rounded-md shadow flex flex-col md:flex-row items-center justify-center md:justify-between gap-y-2 mb-4">
    <div class="flex flex-wrap gap-2 items-center justify-center md:justify-start">
        <button id="toggle-jurisprudence-btn" class="toggle-button text-xs md:text-sm">
            <i class="fas fa-eye-slash mr-1 md:mr-2"></i>
            <span class="md:hidden">Juris.</span>
            <span class="hidden md:inline">Jurisprudência</span>
        </button>
        <button id="toggle-doutrina-btn" class="toggle-button text-xs md:text-sm">
            <i class="fas fa-eye-slash mr-1 md:mr-2"></i>
            <span class="md:hidden">Dout.</span>
            <span class="hidden md:inline">Doutrina</span>
        </button>
    </div>

    <div class="flex items-center flex-wrap justify-center md:justify-end gap-x-4 gap-y-2">
        <div class="flex items-center space-x-1">
            <label for="article-search-input" class="text-sm font-medium text-gray-700">Art.</label>
            <input type="text" id="article-search-input" class="w-20 bg-white border border-gray-300 rounded-md shadow-sm text-sm py-1 px-2">
            <button id="go-to-article-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">
                <i class="fas fa-search"></i> Ir
            </button>
        </div>
        <button id="go-to-notes-btn" class="go-to-notes-btn text-xs md:text-sm">
            <i class="fas fa-pencil-alt mr-2"></i>
            <span class="hidden md:inline">Minhas anotações</span>
            <span class="md:hidden">Anotações</span>
        </button>
    </div>
</div>

<div class="law-content-container" id="law-content">
    
    <div class="text-right mb-4 border-b pb-4">
        <button id="toggle-comment-content-btn" class="bg-indigo-100 text-indigo-700 text-xs font-medium py-1 px-3 rounded-full hover:bg-indigo-200 transition-colors">
            <i class="fas fa-eye-slash mr-2"></i><span>Ocultar Meus Comentários</span>
        </button>
    </div>
    
    {% if law.description %}
        <p class="text-gray-600 italic mb-6">{{ law.description }}</p>
    {% endif %}
    
    {{ law.content | safe }}
</div>

<div class="bookmark-section">
    <h3 class="text-lg font-medium text-gray-800 mb-2">Marcar onde parei:</h3>
    <div class="bookmark-input-group">
        <input type="text" id="last_read_article" class="bookmark-input" placeholder="Ex: Art. 5º, inciso I" value="{{ last_read_article or '' }}">
        <button id="save-bookmark-btn" class="save-bookmark-btn">
            <i class="fas fa-bookmark mr-2"></i> Salvar
        </button>
    </div>
</div>
<div class="mt-8" id="notes-section">
    </div>
{% if not is_completed %}
<form action="{{ url_for('student.mark_complete', law_id=law.id) }}" method="post" class="mt-8">
    </form>
{% else %}
<div class="mt-8 flex justify-center">
    </div>
{% endif %}

<div id="comment-modal-backdrop" class="comment-modal-backdrop">
    <div class="comment-modal-content">
        <h3 class="text-lg font-bold mb-4">Adicionar Comentário</h3>
        <textarea id="comment-modal-textarea" class="comment-modal-textarea" placeholder="Digite seu comentário privado aqui..."></textarea>
        <div class="flex justify-end gap-3">
            <button id="comment-modal-cancel" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md">Cancelar</button>
            <button id="comment-modal-save" class="bg-indigo-600 text-white py-2 px-4 rounded-md">Salvar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- Lógica JavaScript Original (Inalterada) ---
    // (Progresso, Busca de Artigo, Ondas Neurais, Anotações, Bookmark, etc.)
    const progressBar = document.getElementById('reading-progress-bar');
    function updateProgressBar() { /* ...código original... */ }
    window.addEventListener('scroll', updateProgressBar);
    updateProgressBar();
    // ... (todo o resto do seu script original vem aqui, intacto)


    // --- Lógica para os Botões de Toggle (Jurisprudência, Doutrina) ---
    function setupToggleButton(buttonId, contentSelector) {
        const button = document.getElementById(buttonId);
        const lawContent = document.getElementById("law-content");
        if (!button) return;
        let isVisible = true;
        button.addEventListener("click", function () {
            isVisible = !isVisible;
            lawContent.querySelectorAll(contentSelector).forEach(el => {
                el.classList.toggle("conteudo-oculto", !isVisible);
            });
            const icon = this.querySelector('i');
            this.classList.toggle("active", !isVisible);
            icon.className = isVisible ? 'fas fa-eye-slash mr-1 md:mr-2' : 'fas fa-eye mr-1 md:mr-2';
        });
    }
    // A chamada para o antigo botão de comentários foi removida daqui.
    setupToggleButton('toggle-jurisprudence-btn', 'p[style*="background-color: #fef2f2"]');
    setupToggleButton('toggle-doutrina-btn', 'p[style*="background-color: #f5f3ff"]');


    // =====================================================================
    // <<< INÍCIO: LÓGICA COMPLETA PARA O NOVO SISTEMA DE COMENTÁRIOS >>>
    // =====================================================================
    const lawId = '{{ law.id }}';
    const lawContentContainer = document.getElementById('law-content');
    
    // Lógica para o novo botão de VISIBILIDADE do CONTEÚDO dos comentários
    const toggleCommentContentBtn = document.getElementById('toggle-comment-content-btn');
    if (toggleCommentContentBtn) {
        function updateCommentContentButtonState(areVisible) {
            const icon = toggleCommentContentBtn.querySelector('i');
            const text = toggleCommentContentBtn.querySelector('span');
            icon.className = areVisible ? 'fas fa-eye-slash mr-2' : 'fas fa-eye mr-2';
            text.textContent = areVisible ? 'Ocultar Meus Comentários' : 'Mostrar Meus Comentários';
        }
        
        // Verifica a preferência do usuário no armazenamento do navegador
        let contentIsVisible = localStorage.getItem('commentContentVisible') !== 'false';
        updateCommentContentButtonState(contentIsVisible);
        if(!contentIsVisible) {
            lawContentContainer.classList.add('user-comment-content-hidden');
        }
        
        // Adiciona o evento de clique para alternar a visibilidade
        toggleCommentContentBtn.addEventListener('click', () => {
            lawContentContainer.classList.toggle('user-comment-content-hidden');
            contentIsVisible = !lawContentContainer.classList.contains('user-comment-content-hidden');
            updateCommentContentButtonState(contentIsVisible);
            localStorage.setItem('commentContentVisible', contentIsVisible); // Salva a preferência
        });
    }

    // Lógica para ADICIONAR, EXCLUIR e CARREGAR os comentários
    const modalBackdrop = document.getElementById('comment-modal-backdrop');
    const modalTextarea = document.getElementById('comment-modal-textarea');
    const modalSaveBtn = document.getElementById('comment-modal-save');
    const modalCancelBtn = document.getElementById('comment-modal-cancel');
    let currentAnchorId = null;

    function openCommentModal(anchorId) {
        currentAnchorId = anchorId;
        modalTextarea.value = '';
        modalBackdrop.style.display = 'flex';
        modalTextarea.focus();
    }

    function closeCommentModal() {
        modalBackdrop.style.display = 'none';
        currentAnchorId = null;
    }

    function displayComment(comment) {
        const anchorElement = document.getElementById(comment.anchor_paragraph_id);
        if (!anchorElement || !anchorElement.parentNode) return;

        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment-display';
        commentDiv.setAttribute('data-comment-id', comment.id);
        commentDiv.innerHTML = `<p>${comment.content.replace(/\n/g, '<br>')}</p><button class="comment-delete-btn" title="Excluir comentário">&times;</button>`;
        anchorElement.parentNode.insertBefore(commentDiv, anchorElement.nextSibling);

        commentDiv.querySelector('.comment-delete-btn').addEventListener('click', () => deleteComment(comment.id, commentDiv));
        
        const icon = anchorElement.parentNode.querySelector('.comment-icon');
        if(icon) icon.classList.add('has-comment');
    }
    
    async function saveComment() {
        const content = modalTextarea.value.trim();
        if (!content || !currentAnchorId) return;
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        try {
            const response = await fetch(`/student/law/${lawId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ content: content, anchor_paragraph_id: currentAnchorId })
            });
            const data = await response.json();
            if (data.success) {
                displayComment(data.comment);
                closeCommentModal();
            } else {
                alert('Erro ao salvar comentário: ' + data.error);
            }
        } catch (error) {
            console.error('Erro de rede ao salvar comentário:', error);
            alert('Erro de comunicação com o servidor.');
        }
    }
    
    async function deleteComment(commentId, commentElement) {
        if (!confirm('Tem certeza que deseja excluir este comentário?')) return;
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        try {
            const response = await fetch(`/student/comments/${commentId}`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            const data = await response.json();
            if (data.success) {
                const anchorId = commentElement.previousElementSibling.id;
                const wrapper = document.getElementById(anchorId).parentNode;
                commentElement.remove();
                
                const remainingComments = wrapper.querySelectorAll('.comment-display').length;
                if (remainingComments === 0) {
                    const icon = wrapper.querySelector('.comment-icon');
                    if (icon) icon.classList.remove('has-comment');
                }
            } else {
                alert('Erro ao excluir comentário: ' + data.error);
            }
        } catch (error) {
            console.error('Erro de rede ao excluir comentário:', error);
            alert('Erro de comunicação com o servidor.');
        }
    }

    async function initCommentSystem() {
        const paragraphs = lawContentContainer.querySelectorAll('p, li, blockquote');
        paragraphs.forEach((p, index) => {
            if (p.closest('.paragraph-wrapper') || p.style.backgroundColor) return;
            
            const anchorId = `law-p-${index}`;
            p.id = anchorId;

            const wrapper = document.createElement('div');
            wrapper.className = 'paragraph-wrapper';
            p.parentNode.insertBefore(wrapper, p);
            wrapper.appendChild(p);

            const icon = document.createElement('i');
            icon.className = 'fas fa-comment-dots comment-icon';
            icon.title = 'Adicionar comentário privado';
            icon.addEventListener('click', () => openCommentModal(anchorId));
            wrapper.appendChild(icon);
        });

        try {
            const response = await fetch(`/student/law/${lawId}/comments`);
            const data = await response.json();
            if (data.success) {
                data.comments.forEach(displayComment);
            }
        } catch (error) {
            console.error("Erro ao carregar comentários:", error);
        }
        
        modalSaveBtn.addEventListener('click', saveComment);
        modalCancelBtn.addEventListener('click', closeCommentModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) closeCommentModal();
        });
    }

    // Inicia o sistema de comentários ao carregar a página
    initCommentSystem();
});
</script>
{% endblock %}
