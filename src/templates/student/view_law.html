{% extends "base.html" %}

{% block title %}{{ law.title }} - Dose de Lei Di√°ria{% endblock %}

{% block head_extra %}
<style>
    .law-content-container {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        color: #1f2937; /* Dark gray text for readability */
        line-height: 1.7;
        /* Prote√ß√£o contra sele√ß√£o de texto */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        /* Prote√ß√£o contra arrastar */
        -webkit-user-drag: none;
        -khtml-user-drag: none;
        -moz-user-drag: none;
        -o-user-drag: none;
        user-drag: none;
    }
    .law-content-container h1, .law-content-container h2, .law-content-container h3 {
        color: #4c1d95; /* Purple headings */
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
    }
    .law-content-container p {
        margin-bottom: 1em;
    }
    .law-content-container ul, .law-content-container ol {
        margin-left: 1.5em;
        margin-bottom: 1em;
    }
    .law-content-container li {
        margin-bottom: 0.5em;
    }
    .law-content-container strong { font-weight: bold; }
    .law-content-container em { font-style: italic; }
    .law-content-container u { text-decoration: underline; }
    .law-content-container s { text-decoration: line-through; }
    /* Add styles for Quill background colors if used */
    .ql-bg-yellow { background-color: yellow; }
    .ql-bg-red { background-color: red; }
    /* Add other background colors as needed */
    .completed-banner {
        background-color: #d1fae5; /* Light green */
        color: #065f46; /* Dark green */
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        border: 1px solid #a7f3d0;
    }
    .last-read-info {
        background-color: #e0e7ff; /* Indigo 100 */
        color: #3730a3; /* Indigo 800 */
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        border: 1px solid #c7d2fe; /* Indigo 200 */
        font-size: 0.9rem;
    }
    .save-article-form {
        margin-top: 1.5rem;
        padding: 1rem;
        background-color: #f9fafb; /* Gray 50 */
        border: 1px solid #e5e7eb; /* Gray 200 */
        border-radius: 0.5rem;
    }
    
    /* Prote√ß√£o visual adicional */
    .protected-content {
        position: relative;
    }
    
    .protected-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        z-index: 1;
        pointer-events: none;
    }
    
    /* Aviso de prote√ß√£o */
    .protection-notice {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .protection-notice i {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold text-purple-800">{{ law.title }}</h1>
    <a href="{{ url_for("student.dashboard") }}" class="text-purple-600 hover:text-purple-800">
        <i class="fas fa-arrow-left mr-2"></i> Voltar ao Painel
    </a>
</div>

<!-- Aviso de Prote√ß√£o -->
<div class="protection-notice">
    <i class="fas fa-shield-alt"></i>
    <strong>Conte√∫do Protegido:</strong> Este material √© exclusivo para estudantes. C√≥pia, impress√£o e captura de tela est√£o desabilitadas.
</div>

{% if is_completed %}
<div class="completed-banner" role="alert">
    <i class="fas fa-check-circle mr-2"></i> Voc√™ j√° concluiu esta legisla√ß√£o!
</div>
{% elif last_read_article %}
<div class="last-read-info" role="alert">
    <i class="fas fa-bookmark mr-2"></i> Voc√™ parou no artigo: <strong>{{ last_read_article }}</strong>
</div>
{% endif %}

<div class="law-content-container protected-content">
    {% if law.description %}
        <p class="text-gray-600 italic mb-6">{{ law.description }}</p>
    {% endif %}
    
    {{ law.content | safe }}
</div>

{% if not is_completed %}
<!-- Save Last Read Article Form -->
<div class="save-article-form">
    <form action="{{ url_for("student.save_last_read", law_id=law.id) }}" method="POST" class="flex items-center space-x-3">
        <label for="last_article" class="text-sm font-medium text-gray-700">Parou no artigo n¬∫:</label>
        <input type="text" id="last_article" name="last_article" 
               placeholder="Ex: 15" value="{{ last_read_article or '' }}"
               class="shadow-sm appearance-none border border-gray-300 rounded-md py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent w-24">
        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-1 px-3 rounded-md transition duration-300 text-sm">
            <i class="fas fa-save mr-1"></i> Salvar Posi√ß√£o
        </button>
    </form>
</div>

<!-- Mark as Complete Button -->
<div class="mt-8 text-center">
    <form action="{{ url_for("student.mark_complete", law_id=law.id) }}" method="POST">
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 text-lg shadow-md">
            <i class="fas fa-check mr-2"></i> Marcar como Conclu√≠do
        </button>
    </form>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// üõ°Ô∏è PROTE√á√ïES ANTI-PIRATARIA - VISUALIZA√á√ÉO DE LEIS

console.log('üõ°Ô∏è Iniciando prote√ß√µes anti-pirataria para conte√∫do das leis...');

// ‚úÖ Anti-impress√£o (Ctrl+P)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'p' || e.key === 'P')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üö´ Impress√£o Bloqueada', 'A impress√£o deste conte√∫do n√£o √© permitida para proteger os direitos autorais.');
        return false;
    }
});

// ‚úÖ Anti-screenshot (Print Screen)
document.addEventListener('keydown', function(e) {
    if (e.key === 'PrintScreen') {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üì∏ Captura Bloqueada', 'Capturas de tela n√£o s√£o permitidas neste conte√∫do protegido.');
        return false;
    }
});

// ‚úÖ Anti-DevTools (F12, Ctrl+Shift+I, Ctrl+U, Ctrl+Shift+C, Ctrl+Shift+J)
document.addEventListener('keydown', function(e) {
    // F12
    if (e.key === 'F12') {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üîß DevTools Bloqueado', 'Ferramentas de desenvolvedor n√£o s√£o permitidas.');
        return false;
    }
    
    // Ctrl+Shift+I (DevTools)
    if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üîß DevTools Bloqueado', 'Ferramentas de desenvolvedor n√£o s√£o permitidas.');
        return false;
    }
    
    // Ctrl+U (View Source)
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üìÑ C√≥digo Fonte Bloqueado', 'Visualiza√ß√£o do c√≥digo fonte n√£o √© permitida.');
        return false;
    }
    
    // Ctrl+Shift+C (Inspect Element)
    if (e.ctrlKey && e.shiftKey && (e.key === 'C' || e.key === 'c')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üîç Inspe√ß√£o Bloqueada', 'Inspe√ß√£o de elementos n√£o √© permitida.');
        return false;
    }
    
    // Ctrl+Shift+J (Console)
    if (e.ctrlKey && e.shiftKey && (e.key === 'J' || e.key === 'j')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üíª Console Bloqueado', 'Acesso ao console n√£o √© permitido.');
        return false;
    }
});

// ‚úÖ Anti-c√≥pia (Ctrl+C, Ctrl+A, Ctrl+X, Ctrl+S)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'c' || e.key === 'C')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üìã C√≥pia Bloqueada', 'C√≥pia de conte√∫do n√£o √© permitida para proteger os direitos autorais.');
        return false;
    }
    
    if (e.ctrlKey && (e.key === 'a' || e.key === 'A')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üîÑ Sele√ß√£o Bloqueada', 'Sele√ß√£o total do conte√∫do n√£o √© permitida.');
        return false;
    }
    
    if (e.ctrlKey && (e.key === 'x' || e.key === 'X')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('‚úÇÔ∏è Recorte Bloqueado', 'Recorte de conte√∫do n√£o √© permitido.');
        return false;
    }
    
    if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        e.stopPropagation();
        showProtectionAlert('üíæ Salvamento Bloqueado', 'Salvamento da p√°gina n√£o √© permitido.');
        return false;
    }
});

// ‚úÖ Menu de contexto desabilitado (bot√£o direito)
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    showProtectionAlert('üñ±Ô∏è Menu Bloqueado', 'Menu de contexto desabilitado para proteger o conte√∫do.');
    return false;
});

// ‚úÖ Prote√ß√£o contra sele√ß√£o de texto
document.addEventListener('selectstart', function(e) {
    e.preventDefault();
    return false;
});

// ‚úÖ Prote√ß√£o contra arrastar elementos
document.addEventListener('dragstart', function(e) {
    e.preventDefault();
    return false;
});

// ‚úÖ Blur quando perde foco
let isBlurred = false;
let blurTimeout;

window.addEventListener('blur', function() {
    if (!isBlurred) {
        // Pequeno delay para evitar falsos positivos
        blurTimeout = setTimeout(function() {
            document.body.style.filter = 'blur(8px)';
            document.body.style.pointerEvents = 'none';
            isBlurred = true;
            
            // Mostrar aviso
            showFocusWarning();
        }, 100);
    }
});

window.addEventListener('focus', function() {
    if (blurTimeout) {
        clearTimeout(blurTimeout);
    }
    
    if (isBlurred) {
        document.body.style.filter = 'none';
        document.body.style.pointerEvents = 'auto';
        isBlurred = false;
        
        // Remover aviso
        removeFocusWarning();
    }
});

// ‚úÖ Detec√ß√£o avan√ßada de DevTools
let devtools = {open: false, orientation: null};
let devtoolsCheckInterval = setInterval(function() {
    const threshold = 160;
    
    if (window.outerHeight - window.innerHeight > threshold || 
        window.outerWidth - window.innerWidth > threshold) {
        if (!devtools.open) {
            devtools.open = true;
            showProtectionAlert('‚ö†Ô∏è DevTools Detectado', 'Ferramentas de desenvolvedor foram detectadas e bloqueadas!');
            
            // Tentar fechar a janela (pode n√£o funcionar em todos os browsers)
            try {
                window.close();
            } catch(e) {
                // Se n√£o conseguir fechar, redirecionar
                window.location.href = "{{ url_for('student.dashboard') }}";
            }
        }
    } else {
        devtools.open = false;
    }
}, 500);

// ‚úÖ Prote√ß√£o contra zoom excessivo
document.addEventListener('wheel', function(e) {
    if (e.ctrlKey) {
        e.preventDefault();
        showProtectionAlert('üîç Zoom Bloqueado', 'Zoom n√£o √© permitido neste conte√∫do.');
        return false;
    }
});

// ‚úÖ Prote√ß√£o contra teclas de fun√ß√£o
document.addEventListener('keydown', function(e) {
    // Bloquear F1-F12 (exceto F5 para refresh)
    if (e.key.startsWith('F') && e.key !== 'F5') {
        e.preventDefault();
        e.stopPropagation();
        return false;
    }
});

// Fun√ß√£o para mostrar alertas de prote√ß√£o personalizados
function showProtectionAlert(title, message) {
    // Remover alerta anterior se existir
    const existingAlert = document.getElementById('protection-alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    const alert = document.createElement('div');
    alert.id = 'protection-alert';
    alert.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; 
                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
                    color: white; padding: 15px 20px; 
                    border-radius: 10px; z-index: 10000; 
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    max-width: 300px; animation: slideIn 0.3s ease;">
            <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
            <div style="font-size: 14px;">${message}</div>
        </div>
        <style>
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        </style>
    `;
    
    document.body.appendChild(alert);
    
    // Remover ap√≥s 4 segundos
    setTimeout(function() {
        if (alert && alert.parentNode) {
            alert.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => alert.remove(), 300);
        }
    }, 4000);
}

// Fun√ß√£o para mostrar aviso de foco
function showFocusWarning() {
    const warning = document.createElement('div');
    warning.id = 'focus-warning';
    warning.innerHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: rgba(0,0,0,0.95); color: white; padding: 30px; 
                    border-radius: 15px; z-index: 10000; text-align: center;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                    border: 2px solid #7c3aed;">
            <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <h3 style="margin: 0 0 10px 0; font-size: 24px; color: #fbbf24;">Aten√ß√£o!</h3>
            <p style="margin: 0 0 20px 0; font-size: 16px;">
                Voc√™ saiu da √°rea de estudo.<br>
                Clique aqui para continuar estudando.
            </p>
            <div style="font-size: 14px; color: #d1d5db;">
                O conte√∫do foi desfocado por seguran√ßa.
            </div>
        </div>
    `;
    
    document.body.appendChild(warning);
    
    warning.addEventListener('click', function() {
        window.focus();
    });
}

// Fun√ß√£o para remover aviso de foco
function removeFocusWarning() {
    const warning = document.getElementById('focus-warning');
    if (warning) {
        warning.remove();
    }
}

// ‚úÖ Prote√ß√£o contra debug via console
(function() {
    let devtools = false;
    Object.defineProperty(window, 'console', {
        get: function() {
            devtools = true;
            showProtectionAlert('üíª Console Detectado', 'Acesso ao console foi detectado e bloqueado!');
            return {};
        }
    });
})();

// ‚úÖ Limpeza ao sair da p√°gina
window.addEventListener('beforeunload', function() {
    if (devtoolsCheckInterval) {
        clearInterval(devtoolsCheckInterval);
    }
});

// Mensagem final
console.log('üõ°Ô∏è Todas as prote√ß√µes anti-pirataria foram ativadas com sucesso!');
console.log('üìö Conte√∫do protegido - Treino Turbo Concursos');

// Prote√ß√£o adicional: sobrescrever console
setTimeout(function() {
    if (typeof console !== 'undefined') {
        console.log = console.warn = console.error = console.info = console.debug = function() {};
    }
}, 1000);
</script>
{% endblock %}

