{% extends "base.html" %}

{% block title %}{{ law.title }} - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    .law-content-container {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        color: #1f2937; /* Dark gray text for readability */
        line-height: 1.7;
        /* Proteção contra seleção de texto para cópia - Mantida conforme original */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        /* Adicionando borda azul clara */
        border: 1px solid #bfdbfe; /* Tailwind blue-200 */
    }
    .law-content-container h1, .law-content-container h2, .law-content-container h3 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
    }
    .law-content-container p {
        margin-bottom: 1em;
    }
    .law-content-container ul, .law-content-container ol {
        margin-left: 1.5em;
        margin-bottom: 1em;
    }
    .law-content-container li {
        margin-bottom: 0.5em;
    }
    .law-content-container strong { font-weight: bold; }
    .law-content-container em { font-style: italic; }
    .law-content-container u { text-decoration: underline; }
    .law-content-container s { text-decoration: line-through; }
    .ql-bg-yellow { background-color: yellow; }
    .ql-bg-red { background-color: red; }
    .completed-banner {
        background-color: #d1fae5; /* Light green */
        color: #065f46; /* Dark green */
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        border: 1px solid #a7f3d0;
    }
    .last-read-info {
        background-color: #e0e7ff; /* Indigo 100 */
        color: #3730a3; /* Indigo 800 */
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
        border: 1px solid #c7d2fe; /* Indigo 200 */
        font-size: 0.9rem;
    }
    .save-article-form {
        margin-top: 1.5rem;
        padding: 1rem;
        background-color: #f9fafb; /* Gray 50 */
        border: 1px solid #e5e7eb; /* Gray 200 */
        border-radius: 0.5rem;
    }
    /* Estilos para os botões de toggle */
    .toggle-button {
        background-color: #e5e7eb; /* gray-200 */
        color: #374151; /* gray-700 */
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 1px solid #d1d5db; /* gray-300 */
    }
    .toggle-button:hover {
        background-color: #d1d5db; /* gray-300 */
    }
    .toggle-button.active {
        /* Estilo quando o conteúdo está OCULTO (botão para MOSTRAR) */
        background-color: #3b82f6; /* blue-500 */
        color: white;
        border-color: #2563eb; /* blue-600 */
    }
    .toggle-button.active:hover {
        background-color: #2563eb; /* blue-600 */
    }
    /* Classe CSS para ocultar elementos */
    .conteudo-oculto {
        display: none !important; /* Usar !important para garantir a sobreposição */
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
    <h1 class="text-xl md:text-2xl font-bold text-blue-700">{{ law.title }}</h1>
    <a href="{{ url_for("student.dashboard") }}" class="text-sm md:text-base text-purple-600 hover:text-purple-800 whitespace-nowrap self-end sm:self-center">
        <i class="fas fa-arrow-left mr-1 md:mr-2"></i> Voltar ao Painel
    </a>
</div>

<!-- ****** NOVO: Player de Áudio (se disponível) ****** -->
{% if law.audio_url %}
<div class="my-4 p-4 bg-gray-100 border border-gray-300 rounded-lg shadow-sm">
    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
        <i class="fas fa-headphones-alt mr-2"></i> Ouvir a Lei:
    </h4>
    <audio controls class="w-full">
        <source src="{{ law.audio_url }}" type="audio/mpeg"> {# Ajuste o type se necessário (ex: audio/ogg, audio/wav) #}
        Seu navegador não suporta o elemento de áudio.
    </audio>
    <p class="text-xs text-gray-500 mt-1">Áudio fornecido externamente. A qualidade e disponibilidade dependem da fonte.</p>
</div>
{% endif %}
<!-- ****** FIM NOVO ****** -->

{% if is_completed %}
<div class="completed-banner" role="alert">
    <i class="fas fa-check-circle mr-2"></i> Você já concluiu esta legislação!
</div>
{% elif last_read_article %}
<div class="last-read-info" role="alert">
    <i class="fas fa-bookmark mr-2"></i> Você parou no artigo: <strong>{{ last_read_article }}</strong>
</div>
{% endif %}

<!-- Botões de Toggle -->
<div class="flex space-x-2 mb-4">
    <button id="toggle-comments-btn" class="toggle-button">
        <i class="fas fa-eye-slash mr-1"></i> Ocultar Comentários
    </button>
    <button id="toggle-jurisprudence-btn" class="toggle-button">
        <i class="fas fa-eye-slash mr-1"></i> Ocultar Jurisprudências
    </button>
    <button id="toggle-doutrina-btn" class="toggle-button">
        <i class="fas fa-eye-slash mr-1"></i> Ocultar Doutrina
    </button>
</div>
<!-- Fim dos Botões de Toggle -->

<div class="law-content-container" id="law-content">
    {% if law.description %}
        <p class="text-gray-600 italic mb-6">{{ law.description }}</p>
    {% endif %}
    
    {{ law.content | safe }}
</div>

{% if not is_completed %}
<!-- Save Last Read Article Form -->
<div class="save-article-form">
    <form action="{{ url_for("student.save_last_read", law_id=law.id) }}" method="POST" class="flex items-center space-x-3">
        <label for="last_article" class="text-sm font-medium text-gray-700">Parou no artigo nº:</label>
        <input type="text" id="last_article" name="last_article" 
               placeholder="Ex: 15" value="{{ last_read_article or '' }}"
               class="shadow-sm appearance-none border border-gray-300 rounded-md py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent w-24">
        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-1 px-3 rounded-md transition duration-300 text-sm">
            <i class="fas fa-save mr-1"></i> Salvar Posição
        </button>
    </form>
</div>

<!-- Mark as Complete Button -->
<div class="mt-8 text-center">
    <form action="{{ url_for("student.mark_complete", law_id=law.id) }}" method="POST">
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 text-lg shadow-md">
            <i class="fas fa-check mr-2"></i> Marcar como Concluído
        </button>
    </form>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// --- Script para Ocultar/Mostrar Comentários, Jurisprudências e Doutrina (v4 - Adicionado suporte para Doutrina) ---
document.addEventListener("DOMContentLoaded", function () {
    const lawContent = document.getElementById("law-content");
    const toggleCommentsBtn = document.getElementById("toggle-comments-btn");
    const toggleJurisprudenceBtn = document.getElementById("toggle-jurisprudence-btn");
    const toggleDoutrinaBtn = document.getElementById("toggle-doutrina-btn");

    // Seletores baseados nos estilos inline identificados
    const commentSelector = 'p[style*="background-color: #f0fdf4"]';
    const jurisprudenceSelector = 'p[style*="background-color: #fef2f2"]';
    const doutrinaSelector = 'p[style*="background-color: #f5f3ff"]';
    const hiddenClass = "conteudo-oculto"; // Nome da classe CSS para ocultar

    // Estado inicial: conteúdo visível
    let commentsVisible = true;
    let jurisprudenceVisible = true;
    let doutrinaVisible = true;

    function toggleElementsVisibility(selector, makeVisible) {
        const elements = lawContent.querySelectorAll(selector);
        elements.forEach((el) => {
            if (makeVisible) {
                el.classList.remove(hiddenClass);
            } else {
                el.classList.add(hiddenClass);
            }
        });
    }

    // Event listener para o botão de comentários
    toggleCommentsBtn.addEventListener("click", function () {
        commentsVisible = !commentsVisible; // Inverte o estado
        toggleElementsVisibility(commentSelector, commentsVisible); // Aplica o novo estado aos elementos

        // Atualiza a aparência do botão
        if (commentsVisible) {
            this.classList.remove("active");
            this.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Ocultar Comentários';
        } else {
            this.classList.add("active");
            this.innerHTML = '<i class="fas fa-eye mr-1"></i> Mostrar Comentários';
        }
    });

    // Event listener para o botão de jurisprudências
    toggleJurisprudenceBtn.addEventListener("click", function () {
        jurisprudenceVisible = !jurisprudenceVisible; // Inverte o estado
        toggleElementsVisibility(jurisprudenceSelector, jurisprudenceVisible); // Aplica o novo estado aos elementos

        // Atualiza a aparência do botão
        if (jurisprudenceVisible) {
            this.classList.remove("active");
            this.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Ocultar Jurisprudências';
        } else {
            this.classList.add("active");
            this.innerHTML = '<i class="fas fa-eye mr-1"></i> Mostrar Jurisprudências';
        }
    });

    // Event listener para o botão de doutrina
    toggleDoutrinaBtn.addEventListener("click", function () {
        doutrinaVisible = !doutrinaVisible; // Inverte o estado
        toggleElementsVisibility(doutrinaSelector, doutrinaVisible); // Aplica o novo estado aos elementos

        // Atualiza a aparência do botão
        if (doutrinaVisible) {
            this.classList.remove("active");
            this.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Ocultar Doutrina';
        } else {
            this.classList.add("active");
            this.innerHTML = '<i class="fas fa-eye mr-1"></i> Mostrar Doutrina';
        }
    });

    // Garantir que o estado inicial (visível) não tenha a classe de ocultar
    // (Caso a página seja recarregada com elementos ocultos por algum motivo)
    toggleElementsVisibility(commentSelector, true);
    toggleElementsVisibility(jurisprudenceSelector, true);
    toggleElementsVisibility(doutrinaSelector, true);
});
// --- Fim do Script de Toggle ---


// 🛡️ PROTEÇÕES DISCRETAS - APENAS CÓPIA E IMPRESSÃO (Mantidas conforme original)

// ✅ Anti-impressão (Ctrl+P)
document.addEventListener("keydown", function (e) {
    if (e.ctrlKey && (e.key === "p" || e.key === "P")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Impressão não permitida neste conteúdo.");
        return false;
    }
});

// ✅ Anti-cópia (Ctrl+C, Ctrl+A, Ctrl+X)
document.addEventListener("keydown", function (e) {
    // Bloquear Ctrl+C (copiar)
    if (e.ctrlKey && (e.key === "c" || e.key === "C")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Cópia de conteúdo não permitida.");
        return false;
    }

    // Bloquear Ctrl+A (selecionar tudo)
    if (e.ctrlKey && (e.key === "a" || e.key === "A")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Seleção total não permitida.");
        return false;
    }

    // Bloquear Ctrl+X (recortar)
    if (e.ctrlKey && (e.key === "x" || e.key === "X")) {
        e.preventDefault();
        e.stopPropagation();
        alert("Recorte não permitido.");
        return false;
    }
});

// ✅ Proteção contra seleção de texto
document.addEventListener("selectstart", function (e) {
    e.preventDefault();
    return false;
});

// ✅ Menu de contexto desabilitado (botão direito)
document.addEventListener("contextmenu", function (e) {
    e.preventDefault();
    alert("Menu de contexto desabilitado.");
    return false;
});
</script>
{% endblock %}
