{% extends "base.html" %}

{% block title %}{% if law %}Editar Lei{% else %}Adicionar Lei{% endif %} - Admin{% endblock %}

{% block head_extra %}
{# Quill styles removed #}
{# TinyMCE will handle its own styling #}
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-brand-purple mb-6">{% if law %}Editar Lei{% else %}Adicionar Nova Lei{% endif %}</h1>

<form method="POST" action="{% if law %}{{ url_for("admin.edit_law", law_id=law.id) }}{% else %}{{ url_for("admin.add_law") }}{% endif %}" id="law-form" class="bg-white shadow-md rounded-lg p-6 border border-gray-200">
    <div class="mb-4">
        <label for="title" class="block text-brand-text text-sm font-bold mb-2">Título:</label>
        <input type="text" id="title" name="title" value="{{ law.title if law else "" }}" required class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:ring-2 focus:ring-brand-purple focus:border-transparent">
    </div>

    <div class="mb-4">
        <label for="subject_id" class="block text-brand-text text-sm font-bold mb-2">Matéria:</label>
        <select id="subject_id" name="subject_id" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:ring-2 focus:ring-brand-purple focus:border-transparent bg-white">
            <option value="None">-- Nenhuma --</option> {# Option for no subject #}
            {% for subject in subjects %}
                <option value="{{ subject.id }}" {% if law and law.subject_id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
            {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">Você pode gerenciar as matérias <a href="{{ url_for("admin.manage_subjects") }}" class="text-brand-purple hover:underline">aqui</a>.</p>
    </div>

    <div class="mb-4">
        <label for="description" class="block text-brand-text text-sm font-bold mb-2">Descrição (Opcional):</label>
        <textarea id="description" name="description" rows="3" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:ring-2 focus:ring-brand-purple focus:border-transparent">{{ law.description if law else "" }}</textarea>
    </div>

    <div class="mb-6">
        <label for="content-editor" class="block text-brand-text text-sm font-bold mb-2">Conteúdo:</label>
        {# Textarea for TinyMCE #}
        <textarea id="content-editor" name="content" rows="20" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:ring-2 focus:ring-brand-purple focus:border-transparent">{{ law.content | safe if law else "" }}</textarea>
    </div>

    <div class="flex items-center justify-between">
        <button type="submit" class="bg-brand-purple hover:bg-brand-purple-dark text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
            {% if law %}Salvar Alterações{% else %}Adicionar Lei{% endif %}
        </button>
        <a href="{{ url_for("admin.dashboard") }}" class="inline-block align-baseline font-bold text-sm text-brand-purple hover:text-brand-purple-dark">
            Cancelar
        </a>
    </div>
</form>
{% endblock %}

{% block scripts %}
{# Add TinyMCE script from CDN #}
<script src="https://cdn.tiny.cloud/1/i56ikys2e4xesbya3sxi1yscgh46yvqvlb17lc6vsva8pt2z/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

{# Initialize TinyMCE #}
<script>
  tinymce.init({
    selector: "textarea#content-editor",
    plugins: "code table lists link image media wordcount visualblocks visualchars fullscreen preview searchreplace help",
    toolbar: "undo redo | blocks | bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media | code fullscreen preview | help",
    height: 500,
    menubar: "file edit view insert format tools table help",
    // Allow style attributes for more flexibility
    extended_valid_elements: "*[*]", // Be cautious with this, allows all attributes on all elements
    // Or be more specific if needed:
    // extended_valid_elements: "p[style],h2[style],h3[style],strong,em,span[style],div[style]",
    content_style: "body { font-family:Helvetica,Arial,sans-serif; font-size:14px }",
    // Ensure TinyMCE saves the raw HTML content to the textarea
    setup: function (editor) {
        editor.on("change", function () {
            editor.save();
        });
    }
  });
</script>
{% endblock %}
