{% extends "base.html" %}

{% block title %}Painel Admin - Dose de Lei Diária{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .kpi-card {
        background-color: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .kpi-card .value {
        font-size: 2.25rem;
        font-weight: 800;
        color: #4f46e5; /* Roxo índigo */
    }
    .kpi-card .label {
        font-size: 1rem;
        font-weight: 500;
        color: #6b7280;
    }
    .kpi-card .icon {
        font-size: 1.8rem;
        color: #c7d2fe;
        align-self: flex-end;
    }
    .chart-container {
        background-color: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px 0 rgba(0,0,0,.06);
    }
</style>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-brand-purple">Painel do Administrador</h1>
    <div class="space-x-2">
        <a href="{{ url_for('admin.manage_subjects') }}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded"><i class="fas fa-tags mr-2"></i>Matérias</a>
        <a href="{{ url_for('admin.manage_users') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"><i class="fas fa-users-cog mr-2"></i>Usuários {% if pending_users_count > 0 %}<span class="ml-2 bg-red-600 text-red-100 text-xs font-bold rounded-full px-2 py-1">{{ pending_users_count }}</span>{% endif %}</a>
        <a href="{{ url_for('admin.manage_announcements') }}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"><i class="fas fa-bullhorn mr-2"></i>Avisos</a>
        <a href="{{ url_for('admin.add_law') }}" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded"><i class="fas fa-plus mr-2"></i>Adicionar Item</a>
    </div>
</div>

<h2 class="text-2xl font-semibold mb-4 text-brand-purple">Visão Geral</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="kpi-card">
        <div>
            <div class="value">{{ stats.total_users or '0' }}</div>
            <div class="label">Total de Usuários</div>
        </div>
        <i class="fas fa-users icon"></i>
    </div>
    <div class="kpi-card">
        <div>
            <div class="value">{{ stats.active_users_week or '0' }}</div>
            <div class="label">Usuários Ativos (7d)</div>
        </div>
        <i class="fas fa-user-clock icon"></i>
    </div>
    <div class="kpi-card">
        <div>
            <div class="value">{{ stats.total_laws or '0' }}</div>
            <div class="label">Itens de Estudo</div>
        </div>
        <i class="fas fa-gavel icon"></i>
    </div>
    <div class="kpi-card">
        <div>
            <div class="value">{{ pending_users_count or '0' }}</div>
            <div class="label">Cadastros Pendentes</div>
        </div>
        <i class="fas fa-user-plus icon"></i>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="chart-container">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Novos Usuários (Últimos 30 dias)</h3>
        <canvas id="newUsersChart"></canvas>
    </div>
    <div class="chart-container">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 5 Itens Mais Estudados</h3>
        <canvas id="topContentChart"></canvas>
    </div>
</div>

<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-brand-purple">Gerenciar Itens de Estudo</h2>
    <a href="{{ url_for('admin.content_management') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
        <i class="fas fa-edit mr-2"></i>Ver e Gerenciar Todo o Conteúdo
    </a>
</div>

{% endblock %}


{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- CORREÇÃO APLICADA AQUI ---
    // Removemos a variável que vem do Python ({{ charts_data... }}) e colocamos
    // uma lista vazia '[]' diretamente no JavaScript.
    
    // --- Gráfico de Novos Usuários ---
    const newUsersData = {
        labels: [], // Antes era: {{ charts_data.new_users.labels|tojson|safe }}
        values: []  // Antes era: {{ charts_data.new_users.values|tojson|safe }}
    };

    const ctxNewUsers = document.getElementById('newUsersChart').getContext('2d');
    new Chart(ctxNewUsers, {
        type: 'line',
        data: {
            labels: newUsersData.labels,
            datasets: [{
                label: 'Novos Usuários',
                data: newUsersData.values,
                backgroundColor: 'rgba(79, 70, 229, 0.2)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // --- Gráfico de Conteúdo Popular ---
    const topContentData = {
        labels: [], // Antes era: {{ charts_data.top_content.labels|tojson|safe }}
        values: []  // Antes era: {{ charts_data.top_content.values|tojson|safe }}
    };
    
    const ctxTopContent = document.getElementById('topContentChart').getContext('2d');
    new Chart(ctxTopContent, {
        type: 'bar',
        data: {
            labels: topContentData.labels,
            datasets: [{
                label: 'Nº de Visualizações',
                data: topContentData.values,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
        }
    });
});
</script>
{% endblock %}
